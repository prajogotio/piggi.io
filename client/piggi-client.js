!function(){function t(t,e){this.x=t,this.y=e}function e(t){return Math.atan2(t.y,t.x)/Math.PI*180}function i(t,e){var i=t.copy().normalize(),s=t.length(),a=Math.min(e,s);return t.x=i.x*a,t.y=i.y*a,t}function s(t){this.lessThan=t,this.size=0,this.root=null}function a(t){this.value=t,this.left=null,this.right=null,this.parent=null}function o(){this.stackIn=[],this.stackOut=[]}function n(t,e,i,a){function o(t,s,o,n,r){var c=t+o,l=s+n;if(!(0>c||0>l||c>=i.height||l>=i.width)){var d=c*i.width+l,u=Math.abs(e[0]-c)+Math.abs(e[1]-l);if(a)for(var m=0;m<a.length;++m){var g=Math.abs(a[m][0]-c)+Math.abs(a[m][1]-l);u>g&&(u=g)}h[d]>0||0!=i.data[d]&&p.push({cost:r+1+u,par:t*i.width+s,dist:r+1,pos:[c,l]})}}if(t[0]<0||t[1]<0||t[0]>=i.height||t[1]>=i.width||e[0]<0||e[1]<0||e[0]>=i.height||e[1]>=i.width)return[];if(a){for(var n=[],r=0;r<a.length;++r)0!=i.data[a[r][0]*i.width+a[r][1]]&&n.push(a[r]);a=n}var h=new Int32Array(i.data.length),c=new Int32Array(i.data.length).fill(-1),l=function(t,e){return t.cost<e.cost},p=new s(l);h[i.width*t.row+t.col]=1,p.push({cost:0,dist:0,par:-1,pos:t});for(var d=-1,u=1e9;p.size>0;){var m=p.top();p.pop();var g=m.pos[0],f=m.pos[1],y=m.dist,v=g*i.width+f;if(!h[v]){h[v]=1,c[v]=m.par;var E=Math.abs(e[0]-g)+Math.abs(e[1]-f);if(u>E&&(u=E,d=v),g==e[0]&&f==e[1]){d=v;break}if(a){for(var A=!1,r=0;r<a.length;++r)if(a[r][0]==g&&a[r][1]==f){d=v,A=!0;break}if(A)break}o(g,f,-1,0,y),o(g,f,1,0,y),o(g,f,0,-1,y),o(g,f,0,1,y)}}var I=[];if(-1!=d)for(;-1!=d;){var g=Math.floor(d/i.width),f=d-g*i.width;I.push([g,f]),d=c[d]}return I}function r(e,i){for(var s=[],a=0;a<e.length;++a)s.push(new t((e[a][1]+.5)*i.size,(e[a][0]+.5)*i.size));return s}function h(t,e,i,s,a,o,n){this.DELTA_PER_FRAME=Math.ceil(n/qt.SCALER),this.delta=0,this.currentFrame=0,this.numOfFrames=o,this.imgBuffer=t,this.offsetX=e,this.offsetY=i,this.width=s,this.height=a,this.autoReset=!0}function c(e,i,s){this.STANDBY=0,this.MOVING=1,this.ATTACKING=2,this.EATING=3,this.DEAD=4,this.FLOCK_AGGRESIVENESS=400,this.BUILDING_AGGRESIVENESS=640,this.RADIUS_OF_ACCEPTANCE=4,this.MAXIMUM_SPEED=1.5*qt.SCALER,this.AVOIDANCE_SPEED=1.5*qt.SCALER,this.TARGET_RADIUS=64,this.steeringEffect=2.4*qt.SCALER,this.attackRadius=32,this.MOVING_TARGET=!0,this.mass=e,this.radius=s||32,this.invMass=0==e?0:1/e,this.pos=i,this.force=new t(0,0),this.steeringForce=new t(0,0),this.velocity=new t(0,0),this.orientation=0,this.target=null,this.targetStack=[],this.pathTimestamp=-1,this.state=this.STANDBY,this.ENVIRONMENT_CHECK_DELAY=80,this.lastEnvironmentCheck=-80,this.updateCount=0,this.lockOnTarget=null,this.lastAttack=0,this.ATTACK_DELAY=80/qt.SCALER,this.team=0,this.healthPoints=100,this.isAlive=!0,this.strength=30,this.maxHealthPoints=100,this.provoked=!1,this.PERSISTENCE=1e3/qt.SCALER,this.timeOfDeath=-1,this.INTEGRATE_ONLY_MAX_COUNTER=10/qt.SCALER,this.integrateOnlyCounter=10/qt.SCALER,this.checkSurrounding()}function l(t,e,i){c.call(this,t,e,i),this.sprites={}}function p(e,i){this.size=e,this.radius=e/2,this.pos=new t(0,0),this.row=null,this.col=null,this.NORMAL=0,this.DEAD=1,this.ATTACK_TYPE=0,this.EAT_TYPE=1,this.NO_INTERACTION=2,this.SHOW_HEALTHBAR=!0,this.MOVING_TARGET=!1,this.ACTIVE=0,this.PASSIVE=1,this.sprites={},this.state=this.NORMAL,this.interactionDistance=i,this.interactionType=this.ATTACK_TYPE,this.activity=this.ACTIVE,this.MAX_INTERACTION=6,this.interactionCount=0,this.attackRadius=500,this.ATTACK_DELAY=130,this.strength=80,this.lastAttack=0,this.team=0,this.healthPoints=500,this.maxHealthPoints=500,this.isAlive=!0,this.updateCount=0,this.PERSISTENCE=120,this.timeOfDeath=-1,this.destroyable=!0}function d(t,e){l.call(this,100,t,32),this.setSprite(this.STANDBY,new h(Kt.images[C("asset/pig_standby.png",e)],0,0,128,128,4,20)),this.setSprite(this.MOVING,new h(Kt.images[C("asset/pig_running.png",e)],0,0,128,128,6,12)),this.setSprite(this.ATTACKING,new h(Kt.images[C("asset/pig_angry.png",e)],0,0,128,128,3,20)),this.setSprite(this.EATING,new h(Kt.images[C("asset/pig_eating.png",e)],0,0,128,128,2,30)),this.setSprite(this.DEAD,new h(Kt.images[C("asset/pig_death.png",e)],0,0,128,128,1,100)),this.sprites[this.ATTACKING].autoReset=!1,this.team=e,this.healthPoints=this.maxHealthPoints=200,this.strength=30,Jt.team==this.team&&j("music/oink.wav",.1*X(t.x,t.y))}function u(t,e){l.call(this,100,t,32),this.setSprite(this.STANDBY,new h(Kt.images[C("asset/boar_standby.png",e)],0,0,128,128,2,30)),this.setSprite(this.MOVING,new h(Kt.images[C("asset/boar_running.png",e)],0,0,128,128,10,12)),this.setSprite(this.ATTACKING,new h(Kt.images[C("asset/boar_attacking.png",e)],0,0,128,128,3,20)),this.setSprite(this.EATING,new h(Kt.images[C("asset/boar_eating.png",e)],0,0,128,128,2,30)),this.setSprite(this.DEAD,new h(Kt.images[C("asset/boar_death.png",e)],0,0,128,128,1,100)),this.sprites[this.ATTACKING].autoReset=!1,this.team=e,this.healthPoints=this.maxHealthPoints=1200,this.strength=180,this.ATTACK_DELAY=60,Jt.team==this.team&&j("music/oink.wav",.1*X(t.x,t.y))}function m(t,e,i){p.call(this,128,640),this.setSprite(this.NORMAL,new h(Kt.images[C("asset/tower.png",i)],0,0,128,128,2,25)),this.setSprite(this.DEAD,new h(Kt.images[C("asset/tower_death.png",i)],0,0,128,128,1,100)),_(this,Qt.map,t,e),this.type=this.ATTACK_TYPE,this.attackRadius=300,this.ATTACK_DELAY=200/qt.SCALER,this.healthPoints=this.maxHealthPoints=500,this.strength=90,this.team=i,this.MAX_INTERACTION=12,this.weapon=L}function g(t,e,i){p.call(this,128,640),this.setSprite(this.NORMAL,new h(Kt.images[C("asset/castle.png",i)],0,0,128,128,2,25)),this.setSprite(this.DEAD,new h(Kt.images[C("asset/castle_death.png",i)],0,0,128,128,1,100)),_(this,Qt.map,t,e),this.type=this.ATTACK_TYPE,this.attackRadius=400,this.ATTACK_DELAY=120/qt.SCALER,this.strength=250,this.healthPoints=this.maxHealthPoints=1800,this.team=i,this.MAX_INTERACTION=12,this.weapon=T}function f(t,e,i){p.call(this,64,128),this.setSprite(this.NORMAL,new h(Kt.images[C("asset/rice_field.png",i)],0,0,128,128,6,200)),this.setSprite(this.DEAD,new h(Kt.images[C("asset/rice_field_death.png",i)],0,0,128,128,1,100)),_(this,Qt.map,t,e),Qt.map.data[t*Qt.map.width+e]=1,this.team=i,this.interactionType=this.EAT_TYPE,this.SHOW_HEALTHBAR=!1,this.healthPoints=200,this.PERSISTENCE=300/qt.SCALER,this.MAX_INTERACTION=2,this.radius=0,this.coinsToHarvest=1,this.lastProduce=0,this.PRODUCE_DELAY=200/qt.SCALER}function y(t,e,i){p.call(this,64,128),this.setSprite(this.NORMAL,new h(Kt.images[C("asset/super_rice_field.png",i)],0,0,128,128,6,200)),this.setSprite(this.DEAD,new h(Kt.images[C("asset/rice_field_death.png",i)],0,0,128,128,1,100)),_(this,Qt.map,t,e),Qt.map.data[t*Qt.map.width+e]=1,this.team=i,this.interactionType=this.EAT_TYPE,this.SHOW_HEALTHBAR=!1,this.healthPoints=550,this.PERSISTENCE=300/qt.SCALER,this.MAX_INTERACTION=2,this.radius=0,this.coinsToHarvest=3,this.PRODUCE_DELAY=250/qt.SCALER}function v(t,e,i){p.call(this,64,240),this.setSprite(this.NORMAL,new h(Kt.images[C("asset/fence.png",i)],0,0,128,128,1,100)),this.setSprite(this.DEAD,new h(Kt.images[C("asset/fence_death.png",i)],0,0,128,128,1,100)),_(this,Qt.map,t,e),this.team=i,this.type=this.ATTACK_TYPE,this.activity=this.PASSIVE,this.SHOW_HEALTHBAR=!1,this.PERSISTENCE=20,this.healthPoints=100,this.MAX_INTERACTION=2}function E(t,e,i){p.call(this,64,100),this.setSprite(this.NORMAL,new h(Kt.images[C("asset/super_fence.png",i)],0,0,128,128,1,100)),this.setSprite(this.DEAD,new h(Kt.images[C("asset/fence_death.png",i)],0,0,128,128,1,100)),_(this,Qt.map,t,e),this.team=i,this.type=this.ATTACK_TYPE,this.activity=this.PASSIVE,this.SHOW_HEALTHBAR=!1,this.PERSISTENCE=20,this.healthPoints=this.maxHealthPoints=400,this.MAX_INTERACTION=2}function A(t,e,i){p.call(this,128,300),this.setSprite(this.NORMAL,new h(Kt.images[C("asset/pig_ranch.png",i)],0,0,128,128,2,100)),this.setSprite(this.DEAD,new h(Kt.images[C("asset/pig_ranch_death.png",i)],0,0,128,128,1,100)),_(this,Qt.map,t,e),this.team=i,this.type=this.ATTACK_TYPE,this.healthPoints=350,this.maxHealthPoints=350,this.MAX_INTERACTION=8,this.lastProduce=0,this.PRODUCE_DELAY=600/qt.SCALER,this.pigsPerProduction=1,this.product=d,this.productPrice=20}function I(t,e,i){p.call(this,128,300),this.setSprite(this.NORMAL,new h(Kt.images[C("asset/pig_hq.png",i)],0,0,128,128,2,100)),this.setSprite(this.DEAD,new h(Kt.images[C("asset/pig_hq_death.png",i)],0,0,128,128,1,100)),_(this,Qt.map,t,e),this.team=i,this.type=this.ATTACK_TYPE,this.healthPoints=this.maxHealthPoints=1250,this.MAX_INTERACTION=8,this.lastProduce=0,this.PRODUCE_DELAY=600/qt.SCALER,this.pigsPerProduction=1,this.product=u,this.productPrice=200}function w(t,e,i){p.call(this,128,1e3),this.setSprite(this.NORMAL,new h(Kt.images[C("asset/throne.png",i)],0,0,128,128,6,40)),this.setSprite(this.DEAD,new h(Kt.images[C("asset/throne.png",i)],0,0,128,128,1,100)),_(this,Qt.map,t,e),this.team=i,this.type=this.ATTACK_TYPE,this.SHOW_HEALTHBAR=!0,this.PERSISTENCE=700,this.healthPoints=this.maxHealthPoints=5e3,this.MAX_INTERACTION=1e4,this.destroyable=!1}function L(t,i,s){l.call(this,0,t.pos.copy(),32),this.setSprite(this.STANDBY,new h(Kt.images[C("asset/arrow.png",t.team)],0,0,128,128,1,100)),this.setSprite(this.DEAD,new h(Kt.images[C("asset/arrow_death.png",t.team)],0,0,128,128,1,100)),this.target=i,this.owner=t,this.startPoint=t.pos.copy(),this.destination=i.pos.copy(),this.damage=s,this.orientation=e(i.pos.minus(t.pos)),this.updateCount=0,this.maxDelta=40/qt.SCALER,j("music/arrow.wav",X(t.pos.x,t.pos.y))}function T(t,i,s){l.call(this,0,t.pos.copy(),45),this.setSprite(this.STANDBY,new h(Kt.images[C("asset/javelin.png",t.team)],0,0,128,128,1,100)),this.setSprite(this.DEAD,new h(Kt.images[C("asset/javelin_death.png",t.team)],0,0,128,128,1,100)),this.target=i,this.owner=t,this.startPoint=t.pos.copy(),this.destination=i.pos.copy(),this.damage=s,this.orientation=e(i.pos.minus(t.pos)),this.updateCount=0,this.maxDelta=40/qt.SCALER}function _(t,e,i,s){for(var a=Math.floor(t.size/e.size),o=0;a>o;++o)for(var n=0;a>n;++n)e.data[(i+o)*e.width+s+n]=0,e.entry[(i+o)*e.width+s+n]=t;t.pos.x=(s+a/2)*e.size,t.pos.y=(i+a/2)*e.size,t.row=i,t.col=s,e.lastUpdated=Qt.timestep}function O(t,e){for(var i=Math.floor(t.size/e.size),s=0;i>s;++s)for(var a=0;i>a;++a)e.data[(t.row+s)*e.width+t.col+a]=1,e.entry[(t.row+s)*e.width+t.col+a]=null;e.lastUpdated=Qt.timestep}function C(t,e){return e!=Jt.team&&(t+="/b"),t}function k(){this.currentState="BUILD",this.icons=[];var t=[D,M,b,B,N,P,x,U,z,G];this.ICON_SIZE=80;for(var e=0;2>e;++e)for(var i=0;5>i;++i)this.icons.push(new t[5*e+i]((this.ICON_SIZE+2)*i+this.ICON_SIZE/2+3,(this.ICON_SIZE+2)*e+3+this.ICON_SIZE/2,this.ICON_SIZE));this.tower=this.icons[0],this.ranch=this.icons[1],this.farm=this.icons[2],this.fence=this.icons[3],this.upgrade=this.icons[4],this.castle=this.icons[5],this.pighq=this.icons[6],this.garden=this.icons[7],this.wall=this.icons[8],this.deselect=this.icons[9],this.coinInfoSize=40,this.width=5*(this.ICON_SIZE+2)+4,this.height=2*(this.ICON_SIZE+2)+4,this.updatePosition()}function R(t,e,i,s){this.sprite=new h(t,0,0,128,128,1,100),this.state="INACTIVE",this.x=e,this.y=i,this.width=s,this.height=s,this.isLocked=!1,this.cooldown=0,this.MAX_COOL_DOWN=10,this.paid=!1}function S(t,e,i,s,a){R.call(this,t,e,i,s),this.commandType=a,this.isAlive=!0,this.buildingSize=1}function D(t,e,i){S.call(this,Kt.images["asset/tower_icon.png"],t,e,i,"BUILD_TOWER"),this.buildingSize=2,this.tier=Qt.towerTier,this.tierCommand="UPGRADE_TOWER",this.MAX_COOL_DOWN=60}function M(t,e,i){S.call(this,Kt.images["asset/ranch_icon.png"],t,e,i,"BUILD_PIG_RANCH"),this.buildingSize=2,this.tier=Qt.ranchTier,this.tierCommand="UPGRADE_PIG_RANCH",this.MAX_COOL_DOWN=90}function b(t,e,i){S.call(this,Kt.images["asset/farm_icon.png"],t,e,i,"BUILD_FARM"),this.buildingSize=1,this.MAX_COOL_DOWN=30}function B(t,e,i){S.call(this,Kt.images["asset/fence_icon.png"],t,e,i,"BUILD_FENCE"),this.buildingSize=1,this.MAX_COOL_DOWN=15}function N(t,e,i){R.call(this,Kt.images["asset/upgrade_icon.png"],t,e,i)}function P(t,e,i){S.call(this,Kt.images["asset/castle_icon.png"],t,e,i,"BUILD_CASTLE"),this.buildingSize=2,this.isLocked=!0,this.MAX_COOL_DOWN=80}function x(t,e,i){S.call(this,Kt.images["asset/pighq_icon.png"],t,e,i,"BUILD_PIG_HQ"),this.buildingSize=2,this.isLocked=!0,this.MAX_COOL_DOWN=100}function U(t,e,i){S.call(this,Kt.images["asset/garden_icon.png"],t,e,i,"BUILD_GARDEN"),this.buildingSize=1,this.isLocked=!0,this.MAX_COOL_DOWN=30}function z(t,e,i){S.call(this,Kt.images["asset/wall_icon.png"],t,e,i,"BUILD_WALL"),this.buildingSize=1,this.isLocked=!0,this.MAX_COOL_DOWN=15}function G(t,e,i){R.call(this,Kt.images["asset/deselect_icon.png"],t,e,i),this.state="INACTIVE",this.lockedCoins=0,this.toCancel=!1}function F(t,e,i){for(var s=[];t>0;)s.push(t%10),t=Math.floor(t/10);0==s.length&&(s=[0]),s.reverse();var a=.5*e;return{render:function(t){if("white"==i)for(var o=0;o<s.length;++o)t.drawImage(Kt.images["asset/numbers.png"],128*s[o],0,128,128,o*a-(e-a)/2,0,e,e);else if("green"==i){t.drawImage(Kt.images["asset/plus.png"],0,0,128,128,-(e-a)/2,0,e,e);for(var o=0;o<s.length;++o)t.drawImage(Kt.images["asset/numbers-green.png"],128*s[o],0,128,128,(o+1)*a-(e-a)/2,0,e,e)}else{t.drawImage(Kt.images["asset/minus.png"],0,0,128,128,-(e-a)/2,0,e,e);for(var o=0;o<s.length;++o)t.drawImage(Kt.images["asset/numbers-red.png"],128*s[o],0,128,128,(o+1)*a-(e-a)/2,0,e,e)}},width:a*s.length+("white"!=i?a:0),height:e}}function H(t,e,i,s,a){this.delta=0,this.MAX_DELTA=30,this.pos=t.copy(),this.number=F(e,i,s),this.isAlive=!0,this.team=a}function W(){Jt.canvas=document.getElementById("canvas"),Jt.g=Jt.canvas.getContext("2d"),$t.LOADING_FRAME=document.getElementById("loading-frame"),$t.LOGIN_FRAME=document.getElementById("login-frame"),$t.LOBBY_FRAME=document.getElementById("lobby-frame"),$t.ROOM_FRAME=document.getElementById("room-frame"),$t.GAME_FRAME=document.getElementById("game-frame"),Y()}function Y(){for(var t=3,e=0;e<Kt.assetImageList.length;++e){var i=new Image;Kt.images[Kt.assetImageList[e]]=i,i.onload=function(e){return function(){Kt.loadedAssetCount++;var i=document.createElement("canvas");i.width=Kt.images[e].width,i.height=Kt.images[e].height;var s=i.getContext("2d");s.save(),s.drawImage(Kt.images[e],0,0,Kt.images[e].width,Kt.images[e].height,0,0,Kt.images[e].width,Kt.images[e].height);for(var a=s.getImageData(0,0,i.width,i.height),o=0;o<a.data.length;o+=4)a.data[o]-a.data[o+1]<=t&&a.data[o+1]-a.data[o+2]<=t&&(a.data[o]<100||a.data[o+3]<255)||(a.data[o]=Math.min(255,1.25*a.data[o]),a.data[o+1]=Math.min(255,.5*a.data[o+1]),a.data[o+2]=Math.min(255,.5*a.data[o+2]));s.putImageData(a,0,0),s.restore(),Kt.images[e+"/b"]=i,V()}}(Kt.assetImageList[e]),i.src=Kt.assetImageList[e]}Kt.audioContext=new(AudioContext||webkitAudioContext);for(var e=0;e<Kt.assetAudioList.length;++e){var s=Kt.assetAudioList[e],a=new XMLHttpRequest;a.open("GET",s,!0),a.responseType="arraybuffer",a.onload=function(t,e){return function(){e.response&&(Kt.audioContext.decodeAudioData(e.response,function(e){Kt.audio[t]=e},function(t){console.error("decodeAudioData error",t)}),Kt.loadedAssetCount++,V())}}(s,a),a.send(null)}window.asset=Kt}function V(){var t=document.getElementById("loading-caption");t.innerHTML=Math.floor(Kt.loadedAssetCount/(Kt.assetImageList.length+Kt.assetAudioList.length)*100)+"%",Kt.loadedAssetCount==Kt.assetImageList.length+Kt.assetAudioList.length&&K()}function K(){function t(){var t=0,e=new Audio(Kt.assetSoundList[t]);e.volume=.1,e.play(),Kt.callNextSong=function(){t=(t+1)%Kt.assetSoundList.length,e.setAttribute("src",Kt.assetSoundList[t]),e.currentTime=0,e.volume=.1,e.play()},e.addEventListener("ended",function(){Kt.callNextSong()})}canvas.width=window.innerWidth,canvas.height=window.innerHeight,Jt.mouseImg=Kt.images["asset/mouse.png"],Jt.mouseShadowImg=Kt.images["asset/mouse_shadow.png"],Jt.mouse[0]=Jt.canvas.width/2,Jt.mouse[1]=Jt.canvas.height/2,xt(),st(),St(),t(),ut("LOGIN_FRAME")}function j(t,e){if(!Qt.isRedoing){var i=Kt.audio[t],s=Kt.audioContext.createBufferSource();try{s.buffer=i}catch(a){console.log("Error while playing sound:",a)}var o=Kt.audioContext.createGain();o.gain.value=e,s.connect(o),o.connect(Kt.audioContext.destination),s.start(0)}}function X(t,e){var i=Math.abs(Jt.camera[0]+Jt.canvas.width/2-t),s=Math.abs(Jt.camera[1]+Jt.canvas.height/2-e),a=Math.max(0,Math.min(1,1.2-Math.sqrt(i*i+s*s)/800));return.1>a?0:a}function q(){j("music/start.mp3",.1),Kt.callNextSong(),Qt.scheduler&&clearInterval(Qt.scheduler),Jt.gameEventHandlerResetFunction&&Jt.gameEventHandlerResetFunction(),Qt={},$t.GAME_FRAME.style.setProperty("display","block"),Z(Jt.currentRoom.chosenMap),Qt.mapSplit=Jt.currentRoom.mapSplit,Jt.menuBar=new k,Jt.camera[0]=Qt.thrones[Jt.team].pos.x-Jt.canvas.width/2,Jt.camera[1]=Qt.thrones[Jt.team].pos.y-Jt.canvas.height/2,Jt.gameEventHandlerResetFunction=at(),Ct(),Qt.snapshot.timestep=-1,Qt.scheduler=setInterval(function(){return Qt.timestep-Qt.lastSynchronized>qt.ALLOWED_DELAY&&(Bt("Enemy is lagging"),Qt.isLagging=!0),Qt.isLagging&&Qt.timestep-Qt.lastSynchronized>qt.RECOVERED_DELAY?(lt(),Q(),Qt.hasFogOfWar&&Wt(),J(),Qt.hasFogOfWar&&Yt(),pt(),void $()):(Qt.isLagging=!1,Nt(),Qt.isGameOver||(lt(),et()),Q(),Qt.hasFogOfWar&&Wt(),J(),Qt.hasFogOfWar&&Yt(),pt(),$(),void(Qt.isGameOver||Ot()))},qt.FPS)}function Z(t){var e=Zt[t],i=e.width,s=e.height,a=e.asset,o={map:{width:i,height:s,data:new Int32Array(i*s).fill(1),entry:new Array(i*s).fill(null),imgBuffer:Kt.images[a],size:64,lastUpdated:0,specialEffect:e.specialEffect?e.specialEffect():null,fogOfWar:new Int32Array(i*s).fill(1)},deadflocks:[],deadarrows:[],deadbuildings:[],flocks:[],buildings:[],arrows:[],numbers:[],timestep:0,thrones:[],ranchTier:[1,1],towerTier:[1,1],coins:[10,10],lastSynchronized:-1,lastSent:0,localCommandLog:[],commandBackLog:[[],[]],declaredVictory:[!1,!1],isGameOver:!1,madeDeclaration:!1,isRedoing:!1,numberOfFlocks:[0,0],mapSplit:!0,hasFogOfWar:Jt.currentRoom?Jt.currentRoom.fogOfWar:!1,isLagging:!1};Qt=o;for(var n=0;n<e.thrones.length;++n)o.thrones.push(new w(e.thrones[n][0],e.thrones[n][1],n))}function Q(){var t=Jt.mouse,e=Jt.camera,i=16*qt.SCALER,s=4;t[0]<=s&&(e[0]-=i),t[0]>=canvas.width-s-32&&(e[0]+=i),t[1]<=s&&(e[1]-=i),t[1]>=canvas.height-s-32&&(e[1]+=i);var a=180,o=Math.max(0,(Jt.canvas.width-Qt.map.height*Qt.map.size)/2),n=Math.max(0,(Jt.canvas.width-Qt.map.width*Qt.map.size)/2);e[0]<-n&&(e[0]=-n),e[1]<-o&&(e[1]=-o),e[0]=Math.min(e[0],Qt.map.size*Qt.map.width+n-Jt.canvas.width),e[1]=Math.min(e[1],Qt.map.size*Qt.map.height+a+o-Jt.canvas.height)}function J(){var t=Jt.g,e=Jt.camera,i=Jt.canvas,s=Qt.map;if(t.clearRect(0,0,i.width,i.height),t.fillStyle="rgba(0,0,0,0.8)",t.fillRect(0,0,i.width,i.height),t.drawImage(s.imgBuffer,Math.max(0,e[0]),Math.max(0,e[1]),Math.min(i.width,e[0]+i.width),Math.min(i.height,e[1]+i.height),Math.max(0,-e[0]),Math.max(0,-e[1]),Math.min(i.width,e[0]+i.width),Math.min(i.height,e[1]+i.height)),t.save(),t.translate(-e[0],-e[1]),Qt.mapSplit){t.save();var a=Qt.map.height/2*Qt.map.size;t.fillStyle="rgba(255,200,0,0.2)",t.fillRect(0,a-4,Qt.map.size*Qt.map.width,8),t.restore()}for(var o=[Qt.thrones,Qt.deadbuildings,Qt.buildings,Qt.deadflocks,Qt.deadarrows,Qt.flocks,Qt.arrows,Qt.numbers],n=0;n<o.length;++n)for(var r=0;r<o[n].length;++r)o[n][r].render(t);for(var h=[],n=0;n<Qt.numbers.length;++n)Qt.numbers[n].isAlive&&h.push(Qt.numbers[n]);Qt.numbers=h,Qt.map.specialEffect&&Qt.map.specialEffect(t),t.restore(),tt(t)}function $(){Jt.mouseTrapped||Bt("Click on the screen to move the piggi mouse.");var t=Jt.g;t.save(),t.translate(Jt.mouse[0],Jt.mouse[1]),t.save(),t.globalAlpha=.2,t.drawImage(Jt.mouseShadowImg,0,0,128,128,3,10,30,30),t.restore(),"DESTROY"==Jt.state?t.drawImage(Kt.images["asset/destroy.png"],0,0,128,128,0,0,32,32):t.drawImage(Jt.mouseImg,0,0,128,128,0,0,32,32),t.restore()}function tt(t){if("BUILDING"==Jt.state){var e=rt(Jt.mouse[0]+Jt.camera[0],Jt.mouse[1]+Jt.camera[1]);t.save(),t.fillStyle=ot(e[0],e[1],Jt.buildingSize,Jt.team)||!nt(e[0],e[1],Jt.buildingSize)?"red":"green",t.globalAlpha=.5,t.fillRect(e[1]*Qt.map.size-Jt.camera[0],e[0]*Qt.map.size-Jt.camera[1],Jt.buildingSize*Qt.map.size,Jt.buildingSize*Qt.map.size),t.restore()}else if("DESTROY"==Jt.state){var e=rt(Jt.mouse[0]+Jt.camera[0],Jt.mouse[1]+Jt.camera[1]);t.save(),t.fillStyle=Pt(e[0],e[1],Jt.team)?"green":"red",t.globalAlpha=.5,t.fillRect(e[1]*Qt.map.size-Jt.camera[0],e[0]*Qt.map.size-Jt.camera[1],Qt.map.size,Qt.map.size),t.restore()}}function et(){if(Qt.timestep%qt.BACKGROUND_MONEY_RATE==0)for(var t=0;t<Qt.coins.length;++t)Qt.coins[t]+=1;for(var e=[Qt.deadbuildings,Qt.deadflocks,Qt.deadarrows,Qt.flocks,Qt.buildings,Qt.arrows,Qt.thrones],t=0;t<e.length;++t)for(var i=0;i<e[t].length;++i)e[t][i].update(Qt.flocks,Qt.map);it();for(var t=0;t<Qt.coins.length;++t)Qt.coins[t]=Math.min(Qt.coins[t],qt.MAX_COINS);if(Qt.timestep!=Qt.lastSynchronized||Jt.isSinglePlayer||Ct(),Jt.isSinglePlayer&&(Qt.thrones[0].isAlive?Qt.thrones[1].isAlive||(Qt.declaredVictory[0]=!0):Qt.declaredVictory[1]=!0,Qt.declaredVictory[0]||Qt.declaredVictory[1]))return void Dt();Qt.timestep++;(Jt.team+1)%2;if(Qt.snapshot&&(!Qt.thrones[0].snapshot.isAlive||!Qt.thrones[1].snapshot.isAlive)){for(var s=-1,t=0;t<Qt.thrones.length;++t)Qt.thrones[t].snapshot.isAlive||(-1==s?s=t:Qt.thrones[s].snapshot.timeOfDeath>Qt.thrones[t].snapshot.timeOfDeath&&(s=t));return Qt.declaredVictory[s]=!1,Qt.declaredVictory[(s+1)%2]=!0,void Dt()}}function it(){for(var t=[],e=0;e<Qt.deadflocks.length;++e)Qt.deadflocks[e].garbageCollectible()?Qt.deadflocks[e].cleanUp(Qt.flocks,Qt.map):t.push(Qt.deadflocks[e]);Qt.deadflocks=t,t=[];for(var e=0;e<Qt.deadarrows.length;++e)Qt.deadarrows[e].garbageCollectible()?Qt.deadarrows[e].cleanUp(Qt.flocks,Qt.map):t.push(Qt.deadarrows[e]);Qt.deadarrows=t,t=[];for(var e=0;e<Qt.deadbuildings.length;++e)Qt.deadbuildings[e].garbageCollectible()?Qt.deadbuildings[e].cleanUp(Qt.flocks,Qt.map):t.push(Qt.deadbuildings[e]);Qt.deadbuildings=t,t=[];for(var e=0;e<Qt.flocks.length;++e)Qt.flocks[e].isAlive?t.push(Qt.flocks[e]):Qt.deadflocks.push(Qt.flocks[e]);Qt.flocks=t,t=[];for(var e=0;e<Qt.arrows.length;++e)Qt.arrows[e].isAlive?t.push(Qt.arrows[e]):Qt.deadarrows.push(Qt.arrows[e]);Qt.arrows=t,t=[];for(var e=0;e<Qt.buildings.length;++e)Qt.buildings[e].isAlive?t.push(Qt.buildings[e]):Qt.deadbuildings.push(Qt.buildings[e]);Qt.buildings=t}function st(){function t(){return document.pointerLockElement===a||document.mozPointerLockElement===a||document.webkitPointerLockElement===a}function e(){t()?(Nt(),document.addEventListener("mousemove",i,!1),Jt.mouse=[a.width/2,a.height/2],Jt.mouseTrapped=!0):(document.removeEventListener("mousemove",i,!1),Jt.mouseTrapped=!1)}function i(t){var e=Jt.mouse,i=(Jt.camera,t.movementX);movementY=t.movementY,e[0]=Math.min(Math.max(0,e[0]+1.2*i),a.width-32),e[1]=Math.min(Math.max(0,e[1]+1.2*movementY),a.height-32)}function s(e){t()||(a.requestPointerLock=a.requestPointerLock||a.mozRequestPointerLock||a.webkitRequestPointerLock,a.requestPointerLock())}var a=(Jt.camera,Jt.canvas);Qt.map;a.addEventListener("mousedown",s),document.addEventListener("pointerlockchange",e,!1),document.addEventListener("mozpointerlockchange",e,!1),document.addEventListener("webkitpointerlockchange",e,!1);var o=document.getElementById("login-input");o.addEventListener("keydown",function(t){if(13==t.which){var e=o.value;return Vt.emit("login-name",e),ut("LOBBY_FRAME"),!1}}),document.getElementById("create-room").addEventListener("click",function(){document.getElementById("create-room-form").style.display="block",document.getElementById("room-title").value="",document.getElementById("room-title").focus()}),document.getElementById("create-room-cancel").onclick=function(){document.getElementById("create-room-form").style.display="none"},document.getElementById("room-title").addEventListener("keydown",function(t){return 13==t.which?(mt(document.getElementById("room-title").value),document.getElementById("create-room-form").style.display="none",!1):void 0}),document.getElementById("create-room-submit").addEventListener("click",function(t){mt(document.getElementById("room-title").value),document.getElementById("create-room-form").style.display="none"}),document.getElementById("start-game-button").addEventListener("click",function(){if(Jt.isHost)if(Jt.currentRoom.isSinglePlayer)Ft();else{if(-1==Jt.currentRoom.guestId)return;Vt.emit("request-start-game"),Lt()}}),document.getElementById("exit-button").addEventListener("click",function(){Jt.isHost=!1,Vt.emit("exit-room"),ut("LOBBY_FRAME")}),document.getElementById("prev-map").addEventListener("click",function(){var t=Jt.currentRoom.chosenMap-1;0>t&&(t+=Zt.length),Jt.currentRoom.chosenMap=t,Jt.currentRoom.isSinglePlayer||Vt.emit("map-change",t),_t()}),document.getElementById("next-map").addEventListener("click",function(){var t=(Jt.currentRoom.chosenMap+1)%Zt.length;Jt.currentRoom.chosenMap=t,Jt.currentRoom.isSinglePlayer||Vt.emit("map-change",t),_t()}),document.getElementById("tutorial").addEventListener("click",function(){zt()}),document.getElementById("single-player").addEventListener("click",function(){Jt.currentRoom={id:0,title:"Single Player",chosenMap:0,mapSplit:!0,fogOfWar:!0,isSinglePlayer:!0,hostId:Jt.id},Jt.isHost=!0,ut("ROOM_FRAME")}),document.getElementById("tutorial-ok-button").addEventListener("click",function(){Gt()}),document.getElementById("map-split").addEventListener("change",function(){return Jt.isHost?(Jt.currentRoom.mapSplit=this.checked,Jt.currentRoom.isSinglePlayer||Vt.emit("map-split-change",this.checked),void _t()):void _t()}),document.getElementById("map-fog").addEventListener("change",function(){return Jt.isHost?(Jt.currentRoom.fogOfWar=this.checked,Jt.currentRoom.isSinglePlayer||Vt.emit("map-fog-change",this.checked),void _t()):void _t()}),Vt.on("id",function(t){Jt.id=t}),Vt.on("online",function(t){Jt.online.push(t.id),Jt.player[t.id]=t,vt(t)}),Vt.on("new-room",function(t){Jt.room[t.id]=t,Jt.roomList.push(t.id),gt(t)}),Vt.on("room-list",function(t){Jt.roomList=[],Jt.room={};for(var e=0;e<t.length;++e)Jt.roomList.push(t[e].id),Jt.room[t[e].id]=t[e];gt()}),Vt.on("online-player",function(t){Jt.online=[];for(var e=0;e<t.length;++e)Jt.online.push(t[e].id),Jt.player[t[e].id]=t[e];vt()}),Vt.on("offline",function(t){At(t),vt()}),Vt.on("room-created",function(t){Jt.room[t.id]=t,Jt.roomList.push(t.id),Jt.currentRoom=t,Jt.isHost=!0,Jt.currentRoom.chosenMap=0,ut("ROOM_FRAME")}),Vt.on("room-full",function(t){Jt.room[t].full=!0,yt(Jt.room[t]),Jt.enteringRoomId==msg&&wt("Room is currently full")}),Vt.on("room-available",function(t){Jt.room[t].full=!1,yt(Jt.room[t])}),Vt.on("room-exited",function(t){Jt.currentRoom&&Jt.currentRoom.guestId==t&&(Jt.currentRoom.guestId=-1,_t())}),Vt.on("room-unavailable",function(t){Jt.enteringRoomId==t&&(wt("Room is currently unavailable"),Tt())}),Vt.on("room-joined",function(t){t.id==Jt.enteringRoomId&&(Jt.room[t.id]=t,Jt.currentRoom=t,Jt.currentRoom.guestId=Jt.id,Jt.playingWithId=Jt.currentRoom.hostId,ut("ROOM_FRAME"),Tt())}),Vt.on("room-visitor",function(t){guestId=t.id,username=t.username,Jt.currentRoom&&(Jt.currentRoom.guestId=guestId,Jt.player[guestId]={username:username,id:guestId},Jt.playingWithId=guestId,_t())}),Vt.on("map-change",function(t){Jt.currentRoom.chosenMap=t,_t()}),Vt.on("map-split-change",function(t){Jt.currentRoom.mapSplit=t,_t()}),Vt.on("map-fog-change",function(t){Jt.currentRoom.fogOfWar=t,_t()}),Vt.on("room-deleted",function(t){for(var e=[],i=0;i<Jt.roomList.length;++i){var s=Jt.roomList[i];s!=t&&e.push(s)}Jt.roomList=e,delete Jt.room[t],gt()}),Vt.on("room-owner",function(t){Jt.currentRoom&&Jt.currentRoom.id==t&&(Jt.isHost=!0,Jt.currentRoom.guestId=-1,Jt.currentRoom.hostId=Jt.id,_t())}),Vt.on("start-game",function(t){Jt.isHost?Jt.team=t.host:Jt.team=t.guest,Jt.isGameOngoing=!0,Jt.isSinglePlayer=!1,ut("GAME_FRAME"),Tt(),q()}),Vt.on("commands",function(t){Jt.isGameOngoing&&Rt(t)})}function at(){function t(t){var e=Jt.mouse[0]+Jt.camera[0],i=Jt.mouse[1]+Jt.camera[1],s=Jt.mouse[0],a=Jt.mouse[1];if(1==t.buttons){if(Jt.menuBar.containsPoint(s,a))return void Jt.menuBar.onclick(s,a);if("BUILDING"==Jt.state){var o=rt(e,i);!ot(o[0],o[1],Jt.buildingSize,Jt.team)&&nt(o[0],o[1],Jt.buildingSize)&&(Jt.state="NONE",Jt.menuBar.reset(),ht(Jt.currentCommand,[o[0],o[1],Jt.team]),j("music/building.wav",1.5))}else if("DESTROY"==Jt.state){var o=rt(e,i);Pt(o[0],o[1],Jt.team)&&(Jt.state="NONE",ht(jt.DESTROY,[o[0],o[1],Jt.team]),Jt.menuBar.reset(),j("music/destroy.wav",.1))}}else 2==t.buttons&&("BUILDING"==Jt.state||"DESTROY"==Jt.state)&&Jt.menuBar.deselect.onclick()}function e(t){Jt.mouse[0]+Jt.camera[0],Jt.mouse[1]+Jt.camera[1];84==t.which?Jt.menuBar.tower.onclick():65==t.which?Jt.menuBar.farm.onclick():70==t.which?Jt.menuBar.fence.onclick():82==t.which?Jt.menuBar.ranch.onclick():67==t.which?Jt.menuBar.castle.onclick():72==t.which?Jt.menuBar.pighq.onclick():71==t.which?Jt.menuBar.garden.onclick():87==t.which?Jt.menuBar.wall.onclick():85==t.which?Jt.menuBar.upgrade.onclick():68==t.which&&Jt.menuBar.deselect.onclick()}var i=(Jt.camera,Jt.canvas);Qt.map;return i.addEventListener("mousedown",t),document.addEventListener("keydown",e),function(){i.removeEventListener("mousedown",t),document.removeEventListener("keydown",e)}}function ot(t,e,i,s){if(Qt.mapSplit){if(0==s&&t>=Qt.map.height/2)return!0;if(1==s&&t<Qt.map.height/2)return!0}for(var a=0;i>a;++a)for(var o=0;i>o;++o){if(0>t+a||0>e+o||t+a>=Qt.map.height||e+o>=Qt.map.width)return!0;if(Qt.map.entry[(t+a)*Qt.map.width+(e+o)])return!0}for(var a=0;a<Qt.flocks.length;++a)for(var n=0;i>n;++n)for(var r=0;i>r;++r)if(Qt.flocks[a].collidesWithCell(Qt.map,[t+n,e+r]))return!0;return!1}function nt(t,e,i){if(!Qt.hasFogOfWar)return!0;for(var s=t;t+i>s;++s)for(var a=e;e+i>a;++a){if(0>s||0>a||s>=Qt.map.height||a>=Qt.map.width)return!1;var o=s*Qt.map.width+a;if(0==Qt.map.fogOfWar[o])return!1}return!0}function rt(t,e){return[Math.floor(e/Qt.map.size),Math.floor(t/Qt.map.size)]}function ht(t,e){Qt.isLagging||(Qt.localCommandLog.push([Qt.timestep,t,e]),Qt.commandBackLog[Jt.team].push([Qt.timestep,t,e]))}function ct(t,e){var i=t[0],s=t[1],a=t[2];if(s==jt.BUILD_TOWER){if(ot(a[0],a[1],2,a[2]))return void(Qt.coins[a[2]]+=Xt.BUILD_TOWER);Qt.buildings.push(new m(a[0],a[1],a[2]))}else if(s==jt.BUILD_FARM){if(ot(a[0],a[1],1,a[2]))return void(Qt.coins[a[2]]+=Xt.BUILD_FARM);Qt.buildings.push(new f(a[0],a[1],a[2]))}else if(s==jt.BUILD_FENCE){if(ot(a[0],a[1],1,a[2]))return void(Qt.coins[a[2]]+=Xt.BUILD_FENCE);Qt.buildings.push(new v(a[0],a[1],a[2]))}else if(s==jt.BUILD_PIG_RANCH){if(ot(a[0],a[1],2,a[2]))return void(Qt.coins[a[2]]+=Xt.BUILD_PIG_RANCH);Qt.buildings.push(new A(a[0],a[1],a[2]))}else if(s==jt.BUILD_CASTLE){if(ot(a[0],a[1],2,a[2]))return void(Qt.coins[a[2]]+=Xt.BUILD_CASTLE);Qt.buildings.push(new g(a[0],a[1],a[2]))}else if(s==jt.BUILD_GARDEN){if(ot(a[0],a[1],1,a[2]))return void(Qt.coins[a[2]]+=Xt.BUILD_GARDEN);Qt.buildings.push(new y(a[0],a[1],a[2]))}else if(s==jt.BUILD_WALL){if(ot(a[0],a[1],1,a[2]))return void(Qt.coins[a[2]]+=Xt.BUILD_WALL);Qt.buildings.push(new E(a[0],a[1],a[2]))}else if(s==jt.BUILD_PIG_HQ){if(ot(a[0],a[1],2,a[2]))return void(Qt.coins[a[2]]+=Xt.BUILD_PIG_HQ);Qt.buildings.push(new I(a[0],a[1],a[2]))}else if(s==jt.UPGRADE_PIG_RANCH){if(2==Qt.ranchTier[a[0]])return;if(Qt.coins[a[0]]<Xt.UPGRADE_PIG_RANCH)return;Qt.coins[a[0]]-=Xt.UPGRADE_PIG_RANCH,Qt.ranchTier[a[0]]=2}else if(s==jt.UPGRADE_TOWER){if(2==Qt.towerTier[a[0]])return;if(Qt.coins[a[0]]<Xt.UPGRADE_TOWER)return;Qt.coins[a[0]]-=Xt.UPGRADE_TOWER,Qt.towerTier[a[0]]=2}else if(s==jt.BUY){var o=a[0],n=a[1],r=a[2];Qt.coins[o]>=r&&(Qt.coins[o]-=r,dt(o)&&!e&&(Jt.currentCommand=n,Jt.state="BUILDING",Jt.buildingSize=a[3]))}else if(s==jt.DESELECT)Qt.coins[a[0]]+=a[1];else if(s==jt.SYNCHRONIZED)Qt.lastSynchronized=i;else if(s==jt.VICTORY){var h=(a[0]+1)%2;if(Qt.declaredVictory[0]||Qt.declaredVictory[1])return;if(Qt.thrones[h].isAlive)return void(Qt.madeDeclaration=!1);Qt.declaredVictory[a[0]]=!0}else if(s==jt.DESTROY&&Pt(a[0],a[1],a[2])){var c=Qt.map.entry[a[0]*Qt.map.width+a[1]];c.receiveDamage(1e9)}}function lt(){if(!Qt.isGameOver){
Qt.trueTime=Qt.timestep;var t=(Jt.team+1)%2;if(Qt.commandBackLog[t].length>0&&Qt.commandBackLog[t][0][0]<Qt.timestep){var e=Qt.timestep;kt(),Qt.isRedoing=!0;var i=0,s=0,a=0,o=0,n=Qt.commandBackLog;Qt.timestep++;for(var i=0,s=0,r=Qt.timestep;e>r;++r){for(;i<n[0].length&&n[0][i][0]==r;)ct(n[0][i],!0),++i;for(;s<n[1].length&&n[1][s][0]==r;)ct(n[1][s],!0),++s;et()}for(var h=0==t?i:s,c=Jt.team,l=0,p=h>0?n[t][h-1][0]:-1;l<n[c].length&&n[c][l][0]<=p;)l++;Qt.commandBackLog[t]=Qt.commandBackLog[t].splice(h),Qt.commandBackLog[c]=Qt.commandBackLog[c].splice(l),Qt.isRedoing=!1}if(!Qt.isLagging){for(var i=0,s=0,a=0,o=0,n=Qt.commandBackLog;i<n[0].length;)n[0][i][0]==Qt.timestep&&(ct(n[0][i]),a=i+1),++i;for(;s<n[1].length;)n[1][s][0]==Qt.timestep&&(ct(n[1][s]),o=s+1),++s;if(n[t].length>0){for(var h=0==t?a:o,c=Jt.team,l=0,p=h>0?n[t][h-1][0]:-1;l<n[c].length&&n[c][l][0]<=p;)l++;Qt.commandBackLog[t]=Qt.commandBackLog[t].splice(h),Qt.commandBackLog[c]=Qt.commandBackLog[c].splice(l)}}}}function pt(){Jt.menuBar.render(Jt.g)}function dt(t){return Jt.team==t}function ut(t){$t[Jt.appState].style.setProperty("display","none"),"GAME_FRAME"==Jt.appState&&$t[Jt.appState].style.setProperty("z-index","0"),$t[t].style.setProperty("display","block"),Jt.appState=t,"LOGIN_FRAME"==t?document.getElementById("login-input").focus():"LOBBY_FRAME"==t?(document.getElementById("create-room-form").style.display="none",Vt.emit("get-online-player"),Vt.emit("get-room-list")):"ROOM_FRAME"==t?_t():"GAME_FRAME"==t&&$t[Jt.appState].style.setProperty("z-index","5")}function mt(t){Vt.emit("create-room",t)}function gt(t){if(t)document.getElementById("room-list").insertBefore(ft(t),document.getElementById("room-list").lastChild);else{document.getElementById("room-list").innerHTML="";for(var e=0;e<Jt.roomList.length;++e){var i=Jt.roomList[e],s=Jt.room[i];document.getElementById("room-list").appendChild(ft(s))}var a=document.createElement("div");a.setAttribute("class","clear-fix"),document.getElementById("room-list").appendChild(a)}}function ft(t){var e=document.createElement("div"),i="<div class='room-item-title'>["+t.id+"] ";return i+=t.title+"</div>",i+="<div class='room-item-owner'>Owner: ["+t.hostId+"] ",i+=t.hostname+"</div>",i+="<div class='room-item-status'>Status: "+(t.full?'<span class="full">Full</span>':'<span class="avail">Available</span>')+"</div>",e.innerHTML=i,e.onclick=function(){t.full&&wt("Room is currently full."),Jt.enteringRoomId=t.id,Vt.emit("join-room",t.id),Lt()},e.setAttribute("class","room-item"),t.div=e,e}function yt(t){var e=t.div,i="<div class='room-item-title'>["+t.id+"] ";i+=t.title+"</div>",i+="<div class='room-item-owner'>Owner: ["+t.hostId+"] ",i+=t.hostname+"</div>",i+="<div class='room-item-status'>Status: "+(t.full?'<span class="full">Full</span>':'<span class="avail">Available</span>')+"</div>",e.innerHTML=i}function vt(t){if(t)document.getElementById("online-user-list").appendChild(Et(t));else{document.getElementById("online-user-list").innerHTML="";for(var e=0;e<Jt.online.length;++e){var i=Jt.online[e];document.getElementById("online-user-list").appendChild(Et(Jt.player[i]))}}}function Et(t){var e=document.createElement("div"),i="<div class='id'>"+t.id+"</div>";return i+="<div class='name'>"+t.username+"</div>",e.innerHTML=i,e.setAttribute("class","online-list-item"),t.div=e,e}function At(t){for(var e=[],i=0;i<Jt.online.length;++i)Jt.online[i]!=t&&e.push(Jt.online[i]);Jt.online=e,Jt.playingWithId==t&&It(),delete Jt.player[t]}function It(){Qt.declaredVictory[Jt.team]=!0,Dt()}function wt(t){}function Lt(){document.getElementById("waiting-screen").style.display="block"}function Tt(){document.getElementById("waiting-screen").style.display="none"}function _t(){document.getElementById("room-frame-title").innerHTML="Room Title : ["+Jt.currentRoom.id+"] "+Jt.currentRoom.title,document.getElementById("start-game-button").style.display=Jt.isHost?"block":"none",document.getElementById("map-options").style.display=Jt.isHost?"block":"none",document.getElementById("map-split").checked=Jt.currentRoom.mapSplit,document.getElementById("map-fog").checked=Jt.currentRoom.fogOfWar,Jt.currentRoom.isSinglePlayer?(document.getElementById("room-frame-guest").innerHTML="Simple Piggi AI",document.getElementById("guest-title").style.setProperty("background-color","rgba(133,255,133,0.5)"),document.getElementById("start-game-button").style.setProperty("opacity","1.0")):(document.getElementById("room-frame-guest").innerHTML=-1==Jt.currentRoom.guestId?"Waiting.":"["+Jt.currentRoom.guestId+"] "+Jt.player[Jt.currentRoom.guestId].username,-1==Jt.currentRoom.guestId?(document.getElementById("guest-title").style.setProperty("background-color","rgba(255,100,100,0.5)"),document.getElementById("start-game-button").style.setProperty("opacity","0.5")):(document.getElementById("guest-title").style.setProperty("background-color","rgba(133,255,133,0.5)"),document.getElementById("start-game-button").style.setProperty("opacity","1.0"))),document.getElementById("room-frame-host").innerHTML="["+Jt.currentRoom.hostId+"] "+Jt.player[Jt.currentRoom.hostId].username;var t=document.getElementById("map-info-canvas"),e=t.getContext("2d"),i=Zt[Jt.currentRoom.chosenMap];e.drawImage(Kt.images[i.asset],0,0,Kt.images[i.asset].width,Kt.images[i.asset].width,0,0,t.width,t.height),document.getElementById("map-title").innerHTML="Location : "+i.title,document.getElementById("map-dimension").innerHTML="Size : "+i.width+" x "+i.height}function Ot(t){Jt.isSinglePlayer||!t&&Qt.timestep-Qt.lastSent<=qt.SEND_DELAY||(Qt.lastSent=Qt.timestep,Qt.localCommandLog.push([t?Qt.trueTime:Qt.timestep-1,jt.SYNCHRONIZED,[]]),Vt.emit("commands",Qt.localCommandLog),Qt.localCommandLog=[])}function Ct(){for(var t={map:{data:new Int32Array(Qt.map.width*Qt.map.height).fill(1),entry:new Array(Qt.map.width*Qt.map.height).fill(null),lastUpdated:0},deadflocks:[],deadarrows:[],deadbuildings:[],flocks:[],buildings:[],arrows:[],timestep:0,thrones:[],ranchTier:[1,1],towerTier:[1,1],coins:[10,10],declaredVictory:[!1,!1],madeDeclaration:!1,numberOfFlocks:[0,0]},e=0;e<Qt.map.width*Qt.map.height;++e)t.map.data[e]=Qt.map.data[e];for(var e=0;e<Qt.map.width*Qt.map.height;++e)t.map.entry[e]=Qt.map.entry[e];t.map.lastUpdated=Qt.map.lastUpdated;for(var e=0;e<Qt.deadflocks.length;++e)t.deadflocks.push(Qt.deadflocks[e]),Qt.deadflocks[e].createSnapshot();for(var e=0;e<Qt.deadbuildings.length;++e)t.deadbuildings.push(Qt.deadbuildings[e]),Qt.deadbuildings[e].createSnapshot();for(var e=0;e<Qt.deadarrows.length;++e)t.deadarrows.push(Qt.deadarrows[e]),Qt.deadarrows[e].createSnapshot();t.timestep=Qt.timestep;for(var e=0;e<Qt.flocks.length;++e)t.flocks.push(Qt.flocks[e]),Qt.flocks[e].createSnapshot();for(var e=0;e<Qt.buildings.length;++e)t.buildings.push(Qt.buildings[e]),Qt.buildings[e].createSnapshot();for(var e=0;e<Qt.arrows.length;++e)t.arrows.push(Qt.arrows[e]),Qt.arrows[e].createSnapshot();for(var e=0;e<Qt.thrones.length;++e)t.thrones.push(Qt.thrones[e]),Qt.thrones[e].createSnapshot();for(var e=0;e<Qt.ranchTier.length;++e)t.ranchTier[e]=Qt.ranchTier[e],t.towerTier[e]=Qt.towerTier[e],t.coins[e]=Qt.coins[e],t.declaredVictory[e]=Qt.declaredVictory[e],t.numberOfFlocks[e]=Qt.numberOfFlocks[e];t.madeDeclaration=Qt.madeDeclaration,Qt.snapshot=t}function kt(){snapshot=Qt.snapshot;for(var t=0;t<Qt.map.width*Qt.map.height;++t)Qt.map.data[t]=snapshot.map.data[t];for(var t=0;t<Qt.map.width*Qt.map.height;++t)Qt.map.entry[t]=snapshot.map.entry[t];Qt.map.lastUpdated=snapshot.map.lastUpdated,Qt.deadflocks=snapshot.deadflocks;for(var t=0;t<Qt.deadflocks.length;++t)Qt.deadflocks[t].rollback();Qt.flocks=snapshot.flocks;for(var t=0;t<Qt.flocks.length;++t)Qt.flocks[t].rollback();Qt.deadbuildings=snapshot.deadbuildings;for(var t=0;t<Qt.deadbuildings.length;++t)Qt.deadbuildings[t].rollback();Qt.buildings=snapshot.buildings;for(var t=0;t<Qt.buildings.length;++t)Qt.buildings[t].rollback();Qt.deadarrows=snapshot.deadarrows;for(var t=0;t<Qt.deadarrows.length;++t)Qt.deadarrows[t].rollback();Qt.arrows=snapshot.arrows;for(var t=0;t<Qt.arrows.length;++t)Qt.arrows[t].rollback();Qt.timestep=snapshot.timestep,Qt.thrones=snapshot.thrones;for(var t=0;t<Qt.thrones.length;++t)Qt.thrones[t].rollback();for(var t=0;t<Qt.ranchTier.length;++t)Qt.ranchTier[t]=snapshot.ranchTier[t],Qt.towerTier[t]=snapshot.towerTier[t],Qt.coins[t]=snapshot.coins[t],Qt.declaredVictory[t]=snapshot.declaredVictory[t],Qt.numberOfFlocks[t]=snapshot.numberOfFlocks[t];Qt.madeDeclaration=snapshot.madeDeclaration}function Rt(t){var e=(Jt.team+1)%2;Qt.commandBackLog[e]=Qt.commandBackLog[e].concat(t)}function St(){$t.GAME_FRAME.style.setProperty("display","block"),Z(0),Qt.flocks.push(new d(new t(canvas.width/2,canvas.height/2),0));var e=-1e4,i=1e3;Qt.thrones[1].isAlive=!1,Qt.hasFogOfWar=!1,Qt.mapSplit=!1,Qt.scheduler=setInterval(function(){Qt.timestep-e>i&&(Qt.flocks[0].setLockOnTarget({isAlive:!0,MOVING_TARGET:!0,pos:new t(Math.random()*Qt.map.width*Qt.map.size,Math.random()*Qt.map.height*Qt.map.size)},Qt.map),e=Qt.timestep),et(),Jt.camera[0]=Qt.flocks[0].pos.x-Jt.canvas.width/2,Jt.camera[1]=Qt.flocks[0].pos.y-Jt.canvas.height/2,Q(),J()},qt.FPS)}function Dt(){Jt.isGameOngoing&&(Ot(!0),Qt.isGameOver=!0,Jt.isGameOngoing=!1,bt())}function Mt(){Jt.team=0,Jt.state="NONE",Jt.isSinglePlayer=!1,Qt.scheduler&&clearInterval(Qt.scheduler),Jt.gameEventHandlerResetFunction&&Jt.gameEventHandlerResetFunction(),Nt()}function bt(){function t(){document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock,document.exitPointerLock(),Mt(),document.removeEventListener("click",t),document.removeEventListener("keydown",e),document.getElementById("game-over-notice").style.display="none",ut("ROOM_FRAME"),St(),Kt.callNextSong()}function e(){document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock,document.exitPointerLock(),Mt(),document.removeEventListener("click",t),document.removeEventListener("keydown",e),document.getElementById("game-over-notice").style.display="none",ut("ROOM_FRAME"),St(),Kt.callNextSong()}Qt.declaredVictory[Jt.team]?document.getElementById("notice-text1").innerHTML="You Win!":document.getElementById("notice-text1").innerHTML="You Lose.",Jt.mouseTrapped?document.getElementById("notice-text2").innerHTML="Press any key to exit.":document.getElementById("notice-text2").innerHTML="Click here to exit.",document.addEventListener("click",t),document.addEventListener("keydown",e),document.getElementById("game-over-notice").style.display="block"}function Bt(t){document.getElementById("game-notice-box").innerHTML=t,document.getElementById("game-notice-box").style.display="block"}function Nt(){document.getElementById("game-notice-box").style.display="none"}function Pt(t,e,i){var s=Qt.map.entry[t*Qt.map.width+e];return s&&s.team==i&&s.destroyable}function xt(){Zt.push({title:"Pigidow",asset:"asset/pigidow.jpg",width:20,height:32,thrones:[[0,0],[30,18]],specialEffect:null}),Zt.push({title:"Snowy Yosemite",asset:"asset/snowy-yosemite.jpg",width:25,height:40,thrones:[[0,12],[38,13]],specialEffect:Ut}),Zt.push({title:"Furpig Valley",asset:"asset/furpig-valley.jpg",width:4,height:20,thrones:[[0,1],[18,1]],specialEffect:null})}function Ut(){var e=[],i=300;return function(s){if(Math.random()<.4){var a=Math.random()*Qt.map.width*Qt.map.size,o=Math.random()*Qt.map.height*Qt.map.size;e.push({pos:new t(a,o),delta:0})}for(var n=[],r=0;r<e.length;++r)if(!(e[r].delta>=i)){if(n.push(e[r]),e[r].delta%20==0){var h=(Math.random()<.5?-1:1)*Math.random(),c=Math.random(),l=new t(h,c).normalize().times(.8);e[r].v=l}e[r].pos=e[r].pos.plus(e[r].v),s.drawImage(Kt.images["asset/snow.png"],0,0,128,128,e[r].pos.x,e[r].pos.y,32,32),e[r].delta++}e=n}}function zt(){document.getElementById("tutorial-div").style.display="block"}function Gt(){document.getElementById("tutorial-div").style.display="none"}function Ft(){j("music/start.mp3",.1),Kt.callNextSong(),ut("GAME_FRAME"),Qt.scheduler&&clearInterval(Qt.scheduler),Jt.gameEventHandlerResetFunction&&Jt.gameEventHandlerResetFunction(),Qt={},$t.GAME_FRAME.style.setProperty("display","block"),Jt.isGameOngoing=!0,Jt.isSinglePlayer=!0,Z(Jt.currentRoom.chosenMap),Qt.mapSplit=Jt.currentRoom.mapSplit,Jt.menuBar=new k,Jt.team=0,Jt.camera[0]=Qt.thrones[Jt.team].pos.x-Jt.canvas.width/2,Jt.camera[1]=Qt.thrones[Jt.team].pos.y-Jt.canvas.height/2,Jt.gameEventHandlerResetFunction=at(),Ct(),Qt.snapshot.timestep=-1,Qt.AI={},Qt.AI.farms=0,Qt.AI.fences=0,Qt.AI.ranches=0,Qt.AI.towers=0,Qt.scheduler=setInterval(function(){Qt.isGameOver||(Ht(),lt(),et()),Q(),Qt.hasFogOfWar&&Wt(),J(),Qt.hasFogOfWar&&Yt(),pt(),$(),Qt.isGameOver||Ot()},qt.FPS)}function Ht(){var t=(Qt.thrones[1].row,!1);if(!(Qt.timestep%400))for(var e=Qt.map.height;e>=0;--e){for(var i=0;i<Qt.map.width;i++){if(!ot(e-1,i,2,1)){if(t=!0,Math.random()<.9)if(Math.random()<.9){if(Qt.coins[1]>Xt.BUILD_PIG_RANCH){Qt.AI.ranches++,Qt.coins[1]-=Xt.BUILD_PIG_RANCH,ht(jt.BUILD_PIG_RANCH,[e-1,i,1]);break}}else if(Qt.coins[1]>Xt.BUILD_TOWER){Qt.AI.towers++,Qt.coins[1]-=Xt.BUILD_TOWER,ht(jt.BUILD_TOWER,[e-1,i,1]);break}if((Qt.AI.farms+Qt.AI.fences)/(Qt.AI.ranches+Qt.AI.towers+1)>10)break}if(!ot(e,i,1,1)&&(t=!0,Math.random()<.8))if(Math.random()<.7){if(Qt.AI.farms<200&&Qt.coins[1]>Xt.BUILD_FARM){Qt.AI.farms++,Qt.coins[1]-=Xt.BUILD_FARM,ht(jt.BUILD_FARM,[e,i,1]);break}}else if(Math.random()<.001&&Qt.coins[1]>Xt.BUILD_FENCE){Qt.AI.fences++,Qt.coins[1]-=Xt.BUILD_FENCE,ht(jt.BUILD_FENCE,[e,i,1]);break}if(t)break}if(t)break}}function Wt(){function t(t,e){for(var i=t-4;t+4>=i;++i)for(var s=e-4;e+4>=s;++s)if(!(0>i||0>s||i>=Qt.map.height||s>=Qt.map.width)){var a=Math.abs(i-t)+Math.abs(s-e);if(!(a>6)){var o=i*Qt.map.width+s;Qt.map.fogOfWar[o]=4>=a?qt.CLOSE_BY:0==Qt.map.fogOfWar[o]?qt.FAR_AWAY:Qt.map.fogOfWar[o]}}}Qt.map.fogOfWar.fill(0);for(var e=0;e<Qt.flocks.length;++e)if(Qt.flocks[e].team==Jt.team){var i=Math.floor(Qt.flocks[e].pos.y/Qt.map.size),s=Math.floor(Qt.flocks[e].pos.x/Qt.map.size);t(i,s)}for(var e=0;e<Qt.deadflocks.length;++e)if(Qt.deadflocks[e].team==Jt.team){var i=Math.floor(Qt.deadflocks[e].pos.y/Qt.map.size),s=Math.floor(Qt.deadflocks[e].pos.x/Qt.map.size);t(i,s)}for(var e=0;e<Qt.buildings.length;++e)if(Qt.buildings[e].team==Jt.team)for(var a=Qt.buildings[e].size/Qt.map.size,i=Qt.buildings[e].row;i<Qt.buildings[e].row+a;++i)for(var s=Qt.buildings[e].col;s<Qt.buildings[e].col+a;++s)t(i,s);for(var e=0;e<Qt.deadbuildings.length;++e)if(Qt.deadbuildings[e].team==Jt.team)for(var a=Qt.deadbuildings[e].size/Qt.map.size,i=Qt.deadbuildings[e].row;i<Qt.deadbuildings[e].row+a;++i)for(var s=Qt.deadbuildings[e].col;s<Qt.deadbuildings[e].col+a;++s)t(i,s);for(var o=Qt.thrones[Jt.team],a=o.size/Qt.map.size,i=o.row;i<o.row+a;++i)for(var s=o.col;s<o.col+a;++s)t(i,s)}function Yt(){var t=Jt.g,e=Math.max(0,Math.floor(Jt.camera[1]/Qt.map.size)),i=Math.max(0,Math.floor(Jt.camera[0]/Qt.map.size)),s=Math.floor(Jt.canvas.width/Qt.map.size)+1,a=Math.floor(Jt.canvas.height/Qt.map.size)+1;t.save(),t.translate(-Jt.camera[0],-Jt.camera[1]);for(var o=e;e+a>=o;++o)for(var n=i;i+s>=n;++n)if(!(0>o||0>n||o>=Qt.map.height||n>=Qt.map.width)){var r=o*Qt.map.width+n;if(Qt.map.fogOfWar[r]!=qt.CLOSE_BY){var h=n*Qt.map.size,c=o*Qt.map.size;0==Qt.map.fogOfWar[r]?t.fillStyle="rgba(0,0,0,0.6)":t.fillStyle="rgba(0,0,0,0.4)",t.fillRect(h,c,Qt.map.size,Qt.map.size)}}t.restore()}t.prototype.minus=function(e){return new t(this.x-e.x,this.y-e.y)},t.prototype.normalize=function(){var t=this.length();return 0==t?this:(this.x/=t,this.y/=t,this)},t.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},t.prototype.rotate=function(t){t=Math.PI/180*t;var e=this.x,i=this.y,s=Math.cos(t),a=Math.sin(t);return this.x=e*s-i*a,this.y=e*a+i*s,this},t.prototype.dot=function(t){return this.x*t.x+this.y*t.y},t.prototype.copy=function(){return new t(this.x,this.y)},t.prototype.flip=function(){return new t(-this.x,-this.y)},t.prototype.plus=function(e){return new t(this.x+e.x,this.y+e.y)},t.prototype.times=function(e){return new t(this.x*e,this.y*e)},t.prototype.cross=function(t){return this.x*t.y-this.y*t.x},t.prototype.resize=function(t){var e=this.length();return this.x*=t/e,this.y*=t/e,this},s.prototype.push=function(t){if(null==this.root)this.root=new a(t);else{var e=Math.floor((this.size+1)/2),i=new a(t),s=this.atIndex(e);2*e==this.size+1?s.setLeft(i):s.setRight(i),this.heapUp(i)}this.size++},s.prototype.top=function(){return 0==this.size?null:this.root.value},s.prototype.pop=function(){var t=this.atIndex(this.size);this.size>1?(this.root.value=t.value,t.parent.left==t?t.parent.left=null:t.parent.right=null,t.parent=null,this.heapDown(this.root)):this.root=null,this.size--},s.prototype.atIndex=function(t){if(t>this.size)return null;for(var e=[],i=t;i>1;){var s=Math.floor(i/2);2*s==i?e.push("L"):e.push("R"),i=Math.floor(i/2)}for(var a=this.root,o=e.length-1;o>=0;--o)a="L"==e[o]?a.left:a.right;return a},s.prototype.heapUp=function(t){for(;t.parent&&!this.lessThan(t.parent.value,t.value);){var e=t.value;t.value=t.parent.value,t.parent.value=e,t=t.parent}},s.prototype.heapDown=function(t){for(;;){var e=null;if(t.left&&!this.lessThan(t.value,t.left.value)&&(e=t.left),t.right&&!this.lessThan(t.value,t.right.value)&&(!e||this.lessThan(t.right.value,e.value))&&(e=t.right),!e)return;var i=e.value;e.value=t.value,t.value=i,t=e}},a.prototype.setLeft=function(t){this.left=t,t.parent=this},a.prototype.setRight=function(t){this.right=t,t.parent=this},o.prototype.push=function(t){this.stackIn.push(t)},o.prototype.pop=function(){if(this.stackOut.length+this.stackIn.length==0)return null;if(0==this.stackOut.length)for(;this.stackIn.length>0;)this.stackOut.push(this.stackIn.pop());return this.stackOut.pop()},o.prototype.empty=function(){return this.stackIn.length+this.stackOut.length==0};h.prototype.render=function(t,e,i){var s=this.offsetX+this.currentFrame*this.width;t.drawImage(this.imgBuffer,s,this.offsetY,this.width,this.height,0,0,e,i)},h.prototype.update=function(){this.delta>=this.DELTA_PER_FRAME&&(this.delta=0,this.currentFrame++,this.autoReset?this.currentFrame%=this.numOfFrames:this.currentFrame=Math.min(this.currentFrame,this.numOfFrames-1)),this.delta++},h.prototype.reset=function(){this.delta=0,this.currentFrame=0},h.prototype.createSnapshot=function(){this.snapshot={delta:this.delta,currentFrame:this.currentFrame}},h.prototype.rollback=function(){this.delta=this.snapshot.delta,this.currentFrame=this.snapshot.currentFrame},c.prototype.seek=function(){var t=this.steeringEffect;if(null!=this.target){var e=i(this.target.minus(this.pos),this.MAXIMUM_SPEED),s=e.minus(this.velocity).times(t);this.force=this.force.plus(s)}},c.prototype.integrate=function(t){var s=this.force.times(this.invMass);s=i(s,this.AVOIDANCE_SPEED),this.velocity=this.velocity.plus(s),this.velocity=i(this.velocity,this.MAXIMUM_SPEED),this.pos=this.pos.plus(this.velocity);var a=this.steeringForce.times(this.invMass);a=i(a,this.AVOIDANCE_SPEED),this.pos=this.pos.plus(a),this.pos.x=Math.max(0,Math.min(this.pos.x,t.width*t.size-this.radius)),this.pos.y=Math.max(0,Math.min(this.pos.y,t.height*t.size-this.radius)),null!=this.target&&(this.orientation=e(this.velocity)),null==this.target&&0==this.targetStack.length&&null==this.lockOnTarget?this.velocity=this.velocity.times(.95):this.target&&this.target.minus(this.pos).length()<this.TARGET_RADIUS&&(this.target=this.targetStack.pop()),this.lockOnTarget&&this.lockOnTarget.pos.minus(this.pos).length()<.8*this.TARGET_RADIUS&&0==this.targetStack.length&&(this.velocity=this.velocity.times(.5)),this.force.x=this.force.y=0,this.steeringForce.x=this.steeringForce.y=0},c.prototype.setPath=function(t){this.targetStack=t,this.target=t.pop()},c.prototype.getInteractionType=function(t){t.setState(t.ATTACKING)},c.prototype.update=function(e,i){if(this.updateCount++,this.isAlive){var s=0!=this.integrateOnlyCounter;this.integrateOnlyCounter--,0==this.integrateOnlyCounter&&(this.integrateOnlyCounter=this.INTEGRATE_ONLY_MAX_COUNTER);var a=1,o=.04,n=1,r=60,h=1/30;this.checkSurrounding(e,i),this.seek();var c=this.pos.plus(this.velocity.times(h));if(!s){for(var l=0;l<e.length;++l)if(this!=e[l]){var p=this.pos.minus(e[l].pos);if(p.length()<r){var d=c.minus(e[l].pos).normalize();0==d.length()&&(d=new t(1,l),d.normalize());var u=d.times(this.AVOIDANCE_SPEED*a);this.steeringForce=this.steeringForce.plus(u)}}for(var m=-1,g=1e9,l=0;l<e.length;++l)if(this!=e[l]){var f=e[l].pos.plus(e[l].velocity.times(h)),y=c.minus(f).length();g>y&&(m=l,g=y)}if(-1!=m&&g<=e[m].radius){var v=c.minus(e[m].pos.plus(e[m].velocity.times(h)));v=v.normalize().times(this.AVOIDANCE_SPEED*n),this.force=this.force.plus(v)}}if(i){m=-1,g=1e9;var E=[Math.floor(c.y/i.size),Math.floor(c.x/i.size)],A=E[0]*i.width+E[1];if(A>0&&A<i.data.length&&0==i.data[A]){var v=c.minus(new t(i.size*(E[1]+.5),i.size*(E[0]+.5)));v=v.normalize().times(this.AVOIDANCE_SPEED),this.force=this.force.plus(v)}}if(this.integrate(i),s){for(var I=0,w=0,l=0;l<e.length;++l){var p=this.pos.minus(e[l].pos);p.length()<r&&(I+=e[l].orientation,w++)}w>0&&(I/=w,this.orientation=(1-o)*this.orientation+o*I)}if(i)for(var E=[Math.floor(this.pos.y/i.size),Math.floor(this.pos.x/i.size)],L=-1;1>=L;++L)for(var T=-1;1>=T;++T)this.resolveCollisionWithMap(i,[E[0]+L,E[1]+T]);this.handleLockOnTarget(e,i)}},c.prototype.checkSurrounding=function(e,i){function s(t,e){var i=e[0]*t.width+e[1];return i}function a(t,e){if(!(0>t||0>e||t>=i.height||e>=i.width)){var a=s(i,[t,e]);1!=d[a]&&(d[a]=1,p.push([t,e]))}}if(!(this.updateCount-this.lastEnvironmentCheck<=this.ENVIRONMENT_CHECK_DELAY)){this.lastEnvironmentCheck=this.updateCount,this.lockOnTarget&&this.setLockOnTarget(this.lockOnTarget,i);for(var n=1e9,r=-1,h=0;h<e.length;++h)if(e[h].isAlive&&e[h].team!=this.team){var c=e[h].pos.minus(this.pos).length();if(c>this.FLOCK_AGGRESIVENESS)continue;n>c&&(n=c,r=h)}if(-1!=r){var l=this.setLockOnTarget(e[r],i);if(l)return}var p=new o,d=new Int32Array(i.width*i.height).fill(0),u=[Math.floor(this.pos.y/i.size),Math.floor(this.pos.x/i.size)];for(p.push(u),d[s(i,u)]=1;!p.empty();){var m=p.pop(),g=s(i,m),f=new t((m[1]+.5)*i.size,(m[0]+.5)*i.size);if(!(this.pos.minus(f).length()>=this.BUILDING_AGGRESIVENESS)){if(i.entry[g]){var y=i.entry[g];if(y.canInteract(this)){var l=this.setLockOnTarget(y,i);if(l)break}}a(m[0]-1,m[1]),a(m[0]+1,m[1]),a(m[0],m[1]+1),a(m[0],m[1]-1)}}}},c.prototype.handleLockOnTarget=function(t,i){if(this.lockOnTarget){if(!this.lockOnTarget.isAlive)return this.lockOnTarget=null,this.state=this.STANDBY,this.target=null,this.targetStack=[],void(this.provoked=!1);var s=this.lockOnTarget.pos.minus(this.pos).length();s<=this.radius+this.lockOnTarget.radius+this.attackRadius?(this.targetStack=[],this.target=this.lockOnTarget.pos,this.lockOnTarget.MOVING_TARGET&&(this.target=null),this.lockOnTarget.getInteractionType(this),this.state==this.ATTACKING&&(this.updateCount-this.lastAttack>this.ATTACK_DELAY?(this.lastAttack=this.updateCount+this.sprites[this.ATTACKING].DELTA_PER_FRAME*this.sprites[this.ATTACKING].numOfFrames,this.sprites[this.ATTACKING].reset(),Math.random()>.5&&j("music/snort.wav",.05*X(this.pos.x,this.pos.y))):this.updateCount-this.lastAttack==-2*this.sprites[this.ATTACKING].DELTA_PER_FRAME&&(this.lockOnTarget.receiveDamage(this.strength),this.velocity=this.velocity.times(0),this.lockOnTarget.MOVING_TARGET?j("music/hit-1.wav",.2*X(this.pos.x,this.pos.y)):Math.random()>.5?j("music/thump.wav",.2*X(this.pos.x,this.pos.y)):j("music/thud.wav",.2*X(this.pos.x,this.pos.y)))),this.state==this.EATING&&this.updateCount-this.lastAttack>this.ATTACK_DELAY&&(this.lockOnTarget.receiveDamage(this.strength),this.lastAttack=this.updateCount,this.velocity=this.velocity.times(0),Math.random()>.5&&j("music/snort.wav",.05*X(this.pos.x,this.pos.y)))):this.target||(s<2*i.size?this.target=this.lockOnTarget.pos:this.setLockOnTarget(this.lockOnTarget,i,!0)),(this.state==this.ATTACKING||this.state==this.EATING)&&(this.orientation=e(this.lockOnTarget.pos.minus(this.pos).normalize()))}},c.prototype.setLockOnTarget=function(t,e,i){if(!t.isAlive)return!1;if(t==this.lockOnTarget&&!i&&e.lastUpdated==this.pathTimestamp)return!0;if(null!=this.lockOnTarget&&this.lockOnTarget.interactionCount--,this.provoked=!0,this.lockOnTarget=t,t.interactionCount++,t.pos.minus(this.pos)<=e.size)return this.targetStack=[],this.target=t.pos,!0;var s=[Math.floor(this.pos.y/e.size),Math.floor(this.pos.x/e.size)],a=Math.floor(t.pos.y/e.size),o=Math.floor(t.pos.x/e.size),h=[];if(!t.MOVING_TARGET){var c=Math.floor(t.size/e.size);if(a=t.row+Math.floor(c/2),o=t.col+Math.floor(c/2),t.row-1>=0)for(var l=0;c>l;++l)h.push([t.row-1,t.col+l]);if(t.col-1>=0)for(var l=0;c>l;++l)h.push([t.row+l,t.col-1]);if(t.row+c<e.height)for(var l=0;c>l;++l)h.push([t.row+c,t.col+l]);if(t.col+c<e.width)for(var l=0;c>l;++l)h.push([t.row+l,t.col+c])}var p=n(s,[a,o],e,h),d=r(p,e);d[d.length-1]=this.pos,this.setPath(d);var u=p.length>0&&Math.abs(a-p[0][0])+Math.abs(o-p[0][1])<=1;if(!t.MOVING_TARGET&&p.length)for(var c=Math.floor(t.size/e.size),l=0;l<h.length;++l)if(Math.abs(h[l][0]-p[0][0])+Math.abs(h[l][1]-p[0][1])<=1){u=!0;break}return this.pathTimestamp=e.lastUpdated,u},c.prototype.setState=function(t){this.state=t},c.prototype.receiveDamage=function(t){this.isAlive&&(this.provoked=!0,this.healthPoints-=t,this.healthPoints<=0&&(this.healthPoints=0,this.isAlive=!1,this.state=this.DEAD,this.timeOfDeath=this.updateCount,this.lockOnTarget&&(this.lockOnTarget.interactionCount--,this.lockOnTarget=null)))},c.prototype.cleanUp=function(t,e){},c.prototype.garbageCollectible=function(){return!this.isAlive&&this.updateCount-this.timeOfDeath>=this.PERSISTENCE},c.prototype.resolveCollisionWithMap=function(e,i){var s=.1;if(this.collidesWithCell(e,i)){var a=i[0]*e.width+i[1];if(a>0&&a<e.data.length&&0==e.data[a]){var o=this.pos.minus(new t((i[1]+.5)*e.size,(i[0]+.5)*e.size)),n=e.size-Math.abs(o.x),r=new t(Math.sign(o.x),0);Math.abs(o.y)>Math.abs(o.x)&&(n=e.size-Math.abs(o.y),r.x=0,r.y=Math.sign(o.y)),this.pos=this.pos.plus(r.times(n*s))}}},c.prototype.collidesWithCell=function(t,e){return!(e[0]<0||e[1]<0||e[0]>=t.height||e[1]>=t.width||e[1]*t.size>this.pos.x+this.radius||(e[1]+1)*t.size<this.pos.x-this.radius||e[0]*t.size>this.pos.y+this.radius||(e[0]+1)*t.size<this.pos.y-this.radius)},c.prototype.drawTest=function(t){t.save(),t.rotate(Math.PI/2),t.scale(1,-1),t.fillStyle="black",t.beginPath(),t.moveTo(0,this.radius),t.lineTo(this.radius/2,-this.radius/2*Math.sqrt(3)),t.lineTo(-this.radius/2,-this.radius/2*Math.sqrt(3)),t.closePath(),t.fill(),t.restore()},l.prototype=Object.create(c.prototype),l.prototype.setSprite=function(t,e){this.sprites[t]=e},l.prototype.update=function(t,e){c.prototype.update.call(this,t,e),this.sprites[this.state].update()},l.prototype.render=function(t){if(t.save(),!this.isAlive){var e=1-Math.max(0,(this.updateCount-this.timeOfDeath)/this.PERSISTENCE);e=.5>e?.5:1,t.globalAlpha=e}t.translate(Math.floor(this.pos.x),Math.floor(this.pos.y)),t.rotate(Math.floor((this.orientation+90)/180*Math.PI*10)/10),t.translate(-this.radius,-this.radius),this.sprites[this.state].render(t,2*this.radius,2*this.radius),t.restore()},l.prototype.integrate=function(t){c.prototype.integrate.call(this,t),null==this.target&&this.state!=this.ATTACKING&&this.state!=this.EATING&&(this.state=this.STANDBY)},l.prototype.setPath=function(t){c.prototype.setPath.call(this,t),this.state==this.STANDBY?this.state=this.MOVING:null!=this.targetStack[0]&&this.pos.minus(this.targetStack[0]).length()>=4*this.radius&&(this.state=this.MOVING)},l.prototype.createSnapshot=function(){this.snapshot={pos:this.pos.copy(),force:this.force.copy(),steeringForce:this.steeringForce.copy(),velocity:this.velocity.copy(),orientation:this.orientation,target:this.target,targetStack:this.targetStack.slice(),pathTimestamp:this.pathTimestamp,state:this.state,lastEnvironmentCheck:this.lastEnvironmentCheck,updateCount:this.updateCount,lockOnTarget:this.lockOnTarget,lastAttack:this.lastAttack,healthPoints:this.healthPoints,isAlive:this.isAlive,provoked:this.provoked,timeOfDeath:this.timeOfDeath,integrateOnlyCounter:this.integrateOnlyCounter},this.sprites[this.state].createSnapshot()},l.prototype.rollback=function(){this.pos=this.snapshot.pos.copy(),this.force=this.snapshot.force.copy(),this.steeringForce=this.snapshot.steeringForce.copy(),this.velocity=this.snapshot.velocity.copy(),this.orientation=this.snapshot.orientation,this.target=this.snapshot.target,this.targetStack=this.snapshot.targetStack,this.pathTimestamp=this.snapshot.pathTimestamp,this.state=this.snapshot.state,this.lastEnvironmentCheck=this.snapshot.lastEnvironmentCheck,this.updateCount=this.snapshot.updateCount,this.lockOnTarget=this.snapshot.lockOnTarget,this.lastAttack=this.snapshot.lastAttack,this.healthPoints=this.snapshot.healthPoints,this.isAlive=this.snapshot.isAlive,this.provoked=this.snapshot.provoked,this.timeOfDeath=this.snapshot.timeOfDeath,this.integrateOnlyCounter=this.snapshot.integrateOnlyCounter,this.sprites[this.state].rollback()},p.prototype.setSprite=function(t,e){this.sprites[t]=e},p.prototype.render=function(t){if(this.sprites[this.state]){if(t.save(),t.translate(this.pos.x-this.size/2,this.pos.y-this.size/2),t.save(),!this.isAlive){var e=1-Math.max(0,(this.updateCount-this.timeOfDeath)/this.PERSISTENCE);e=.5>e?.5:1,t.globalAlpha=e}this.sprites[this.state].render(t,this.size,this.size),t.restore(),t.fillStyle="rgba(0,0,0,0.5)",this.SHOW_HEALTHBAR&&(t.fillRect(2,0,this.size-4,8),t.fillStyle="rgba(255,255,0,0.9)",t.fillRect(3,1,(this.size-6)*this.healthPoints/this.maxHealthPoints,6)),t.restore()}},p.prototype.canInteract=function(t){return this.team!=t.team?this.interactionType==this.NO_INTERACTION?!1:this.activity!=this.PASSIVE||t.provoked?this.interactionCount>=this.MAX_INTERACTION||t.pos.minus(this.pos).length()>=this.interactionDistance?!1:!0:!1:void 0},p.prototype.getInteractionType=function(t){this.interactionType==this.ATTACK_TYPE?t.setState(t.ATTACKING):this.interactionType==this.EAT_TYPE&&t.setState(t.EATING)},p.prototype.receiveDamage=function(t){c.prototype.receiveDamage.call(this,t)},p.prototype.update=function(t,e){this.updateCount++,this.sprites[this.state].update()},p.prototype.cleanUp=function(t,e){O(this,e)},p.prototype.garbageCollectible=function(){return c.prototype.garbageCollectible.call(this)},p.prototype.createSnapshot=function(){this.snapshot={state:this.state,lastAttack:this.lastAttack,healthPoints:this.healthPoints,isAlive:this.isAlive,updateCount:this.updateCount,interactionCount:this.interactionCount,timeOfDeath:this.timeOfDeath},this.sprites[this.state].createSnapshot()},p.prototype.rollback=function(){this.state=this.snapshot.state,this.lastAttack=this.snapshot.lastAttack,this.healthPoints=this.snapshot.healthPoints,this.isAlive=this.snapshot.isAlive,this.updateCount=this.snapshot.updateCount,this.timeOfDeath=this.snapshot.timeOfDeath,this.interactionCount=this.snapshot.interactionCount,this.sprites[this.state].rollback()},d.prototype=Object.create(l.prototype),d.prototype.receiveDamage=function(t){l.prototype.receiveDamage.call(this,t),this.isAlive||Qt.numberOfFlocks[this.team]--},d.prototype.update=function(t,e){if(l.prototype.update.call(this,t,e),this.isAlive&&null==this.lockOnTarget){var i=this.team+1;i%=2,this.setLockOnTarget(Qt.thrones[i],e)}},d.prototype.render=function(e){if(Jt.team!=this.team&&Qt.hasFogOfWar){for(var i=!1,s=Math.floor(this.pos.y/Qt.map.size),a=Math.floor(this.pos.x/Qt.map.size),o=s-1;s+1>=o;++o){for(var n=a-1;a+1>=n;++n)if(!(0>o||0>n||o>=Qt.map.height||n>=Qt.map.width)){var r=o*Qt.map.width+n,h=new t((n+.5)*Qt.map.size,(o+.5)*Qt.map.size);if(h.minus(this.pos).length()<1.5*this.radius&&0!=Qt.map.fogOfWar[r]){i=!0;break}}if(i)break}i&&l.prototype.render.call(this,e)}else l.prototype.render.call(this,e)},u.prototype=Object.create(d.prototype),m.prototype=Object.create(p.prototype),m.prototype.update=function(t,e){if(p.prototype.update.call(this,t,e),this.isAlive&&!(this.updateCount-this.lastAttack<=this.ATTACK_DELAY)){
this.lastAttack=this.updateCount;for(var i=0;i<t.length;++i)if(t[i].isAlive&&t[i].team!=this.team&&t[i].pos.minus(this.pos).length()<=this.attackRadius)return void Qt.arrows.push(new this.weapon(this,t[i],this.strength));for(var i=Math.max(0,this.row-3);i<Math.min(this.row+5,Qt.map.height);++i)for(var s=Math.max(0,this.col-3);s<Math.min(this.col+5,Qt.map.width);++s){var a=Qt.map.entry[i*Qt.map.width+s];if(null!=a&&a.isAlive&&a.team!=this.team)return void Qt.arrows.push(new this.weapon(this,a,this.strength))}}},m.prototype.render=function(t){if(Jt.team!=this.team&&Qt.hasFogOfWar)for(var e=this.size/Qt.map.size,i=this.row;i<this.row+e;++i)for(var s=this.col;s<this.col+e;++s){var a=i*Qt.map.width+s;if(0!=Qt.map.fogOfWar[a])return void p.prototype.render.call(this,t)}else p.prototype.render.call(this,t)},g.prototype=Object.create(m.prototype),f.prototype=Object.create(p.prototype),f.prototype.render=function(t){m.prototype.render.call(this,t)},f.prototype.createSnapshot=function(){A.prototype.createSnapshot.call(this)},f.prototype.rollback=function(){A.prototype.rollback.call(this)},f.prototype.update=function(t,e){p.prototype.update.call(this,t,e),this.updateCount-this.lastProduce<=this.PRODUCE_DELAY||(this.lastProduce=this.updateCount,Qt.coins[this.team]+=this.coinsToHarvest,Qt.isRedoing||Qt.numbers.push(new H(this.pos,this.coinsToHarvest,22,"green",this.team)))},y.prototype=Object.create(f.prototype),v.prototype=Object.create(p.prototype),v.prototype.render=function(t){m.prototype.render.call(this,t)},v.prototype.canInteract=function(t){return p.prototype.canInteract.call(this,t)&&0==t.targetStack.length},E.prototype=Object.create(v.prototype),A.prototype=Object.create(p.prototype),A.prototype.render=function(t){m.prototype.render.call(this,t)},A.prototype.update=function(e,i){if(p.prototype.update.call(this,e,i),this.isAlive&&!(Qt.numberOfFlocks[this.team]>=qt.MAX_FLOCKS_PER_TEAM||this.updateCount-this.lastProduce<=this.PRODUCE_DELAY||Qt.coins[this.team]<this.productPrice))for(var s=[[2,0],[2,1],[-1,0],[-1,1],[0,-1],[1,-1],[0,2],[1,2]],a=0;a<s.length;++a){var o=s[a][0]+this.row,n=s[a][1]+this.col;if(!(0>o||0>n||o>=Qt.map.height||n>=Qt.map.width)&&1==Qt.map.data[o*Qt.map.width+n]){for(var r=0;r<this.pigsPerProduction;++r)Qt.coins[this.team]-=this.productPrice,this.lastProduce=this.updateCount,Qt.numberOfFlocks[this.team]++,Qt.flocks.push(new this.product(new t((n+.5)*Qt.map.size,(o+.5)*Qt.map.size),this.team)),Qt.isRedoing||Qt.numbers.push(new H(this.pos,this.productPrice,22,"red",this.team));return}}},A.prototype.createSnapshot=function(){p.prototype.createSnapshot.call(this),this.snapshot.lastProduce=this.lastProduce},A.prototype.rollback=function(){p.prototype.rollback.call(this),this.lastProduce=this.snapshot.lastProduce},I.prototype=Object.create(A.prototype),w.prototype=Object.create(p.prototype),w.prototype.render=function(t){m.prototype.render.call(this,t)},L.prototype=Object.create(l.prototype),L.prototype.render=function(t){d.prototype.render.call(this,t)},L.prototype.update=function(){if(this.updateCount++,this.isAlive){var t=17;this.pos=this.destination.minus(this.startPoint).times(Math.min(this.updateCount,this.maxDelta-t)/(this.maxDelta-t)).plus(this.startPoint),this.updateCount+t>=this.maxDelta&&(this.state!=this.DEAD&&j("music/arrow_impact.wav",.3*X(this.pos.x,this.pos.y)),this.state=this.DEAD,this.target.receiveDamage(this.damage),this.damage=0),this.updateCount>=this.maxDelta&&(this.isAlive=!1,this.timeOfDeath=this.updateCount)}},L.prototype.createSnapshot=function(){l.prototype.createSnapshot.call(this),this.snapshot.updateCount=this.updateCount,this.snapshot.damage=this.damage},L.prototype.rollback=function(){l.prototype.rollback.call(this),this.updateCount=this.snapshot.updateCount,this.damage=this.snapshot.damage},T.prototype=Object.create(L.prototype),k.prototype.updatePosition=function(){var t=Jt.canvas.width,e=Jt.canvas.height;this.x=t/2,this.y=e-this.height/2},k.prototype.render=function(t){t.save(),this.updatePosition(),t.translate(this.x-this.width/2,this.y-this.height/2),t.fillStyle="rgba(0,0,0,0.2)",t.fillRect(0,0,this.width,this.height);for(var e=0;e<this.icons.length;++e)this.icons[e].update(),this.icons[e].render(t);var i=40,s=i+.5*i*4+4+4,a=i+4;t.translate(-s,this.height-a),t.fillRect(0,0,s,a),t.drawImage(Kt.images["asset/pig_coin.png"],0,0,128,128,2,2,i,i),t.translate(i+4,0),t.fillStyle="rgba(255,245,200,0.5)",t.fillRect(1,3,s-i-4-2,a-6),t.translate(4,4);var o=F(Qt.coins[Jt.team],32,"white");t.translate(s-i-8-o.width-.5*i/2,0),o.render(t),t.restore()},k.prototype.containsPoint=function(t,e){return this.x-this.width/2<=t&&t<=this.x+this.width/2&&this.y-this.height/2<=e&&e<=this.y+this.height/2},k.prototype.onclick=function(t,e){for(var i=t-(this.x-this.width/2),s=e-(this.y-this.height/2),a=0;a<this.icons.length;++a)if(this.icons[a].containsPoint(i,s))return void this.icons[a].onclick()},k.prototype.reset=function(){for(var t=0;t<this.icons.length;++t)this.icons[t].state="INACTIVE",this.icons[t].paid=!1;this.deselect.toCancel=!1},R.prototype.render=function(t){t.save(),"INACTIVE"==this.state?t.fillStyle="rgba(255,255,255,0.5)":"ACTIVE"==this.state&&(t.fillStyle="rgba(255,255,100,0.8)"),t.translate(this.x-this.width/2,this.y-this.height/2),t.fillRect(0,0,this.width,this.height),this.sprite.render(t,this.width,this.height),this.isLocked&&t.drawImage(Kt.images["asset/locked_icon.png"],0,0,128,128,0,0,this.width,this.height),("UNCLICKABLE"==this.state||"LOCKED"==this.state)&&(t.fillStyle="rgba(0,0,0,0.5)","LOCKED"==this.state&&(t.fillStyle="rgba(0,0,0,0.8)"),t.fillRect(0,0,this.width,this.height)),t.restore()},R.prototype.update=function(){},R.prototype.containsPoint=function(t,e){return k.prototype.containsPoint.call(this,t,e)},R.prototype.onclick=function(){if("UNCLICKABLE"!=this.state&&"LOCKED"!=this.state&&"ACTIVE"!=this.state){for(var t=0;t<Jt.menuBar.icons.length;++t)Jt.menuBar.icons[t].state="LOCKED";Jt.menuBar.deselect.state="INACTIVE",Jt.menuBar.deselect.toCancel=!0,this.state="ACTIVE"}},S.prototype=Object.create(R.prototype),S.prototype.update=function(){return"LOCKED"!=this.state&&"ACTIVE"!=this.state&&this.isAlive?this.cooldown>0?(this.state="UNCLICKABLE",void this.cooldown--):void(Xt[this.commandType]<=Qt.coins[Jt.team]?this.state="INACTIVE":this.state="UNCLICKABLE"):void 0},S.prototype.onclick=function(){R.prototype.onclick.call(this),"ACTIVE"!=this.state||this.paid||(ht(jt.BUY,[Jt.team,jt[this.commandType],Xt[this.commandType],this.buildingSize]),Jt.menuBar.deselect.lockedCoins=Xt[this.commandType],this.cooldown=this.MAX_COOL_DOWN,this.paid=!0)},S.prototype.render=function(t){R.prototype.render.call(this,t),"LOCKED"==this.state||this.isLocked||this.renderPrice(t,Xt[this.commandType])},S.prototype.renderPrice=function(t,e){t.save(),t.translate(this.x-this.width/2,this.y-this.height/2);var i=F(e,14,"white");t.translate(this.width-i.width-2,this.height-i.height-2),t.fillStyle="rgba(0,0,0,0.5)",t.fillRect(0,0,i.width,i.height),i.render(t),t.translate(-16,0),t.fillRect(0,0,16,14),t.drawImage(Kt.images["asset/pig_coin.png"],0,0,128,128,0,0,14,14),t.restore()},D.prototype=Object.create(S.prototype),D.prototype.update=function(){if("ACTIVE"==Jt.menuBar.upgrade.state){if(2==this.tier[Jt.team]||Xt[this.tierCommand]>Qt.coins[Jt.team])return void(this.state="UNCLICKABLE");this.state="INACTIVE"}else S.prototype.update.call(this)},D.prototype.onclick=function(){if("ACTIVE"==Jt.menuBar.upgrade.state){if("UNCLICKABLE"==this.state)return;ht(jt[this.tierCommand],[Jt.team]),this.cooldown=this.MAX_COOL_DOWN,Jt.menuBar.reset()}else S.prototype.onclick.call(this)},D.prototype.render=function(t){"ACTIVE"==Jt.menuBar.upgrade.state?(R.prototype.render.call(this,t),S.prototype.renderPrice.call(this,t,Xt[this.tierCommand])):S.prototype.render.call(this,t)},M.prototype=Object.create(S.prototype),M.prototype.update=function(){D.prototype.update.call(this)},M.prototype.onclick=function(){D.prototype.onclick.call(this)},M.prototype.render=function(t){D.prototype.render.call(this,t)},b.prototype=Object.create(S.prototype),B.prototype=Object.create(S.prototype),N.prototype=Object.create(R.prototype),N.prototype.update=function(){return"ACTIVE"!=this.state&&"LOCKED"!=this.state?Qt.towerTier[Jt.team]+Qt.ranchTier[Jt.team]>=4?void(this.state="UNCLICKABLE"):void(this.state="INACTIVE"):void 0},P.prototype=Object.create(S.prototype),P.prototype.update=function(){if("LOCKED"!=this.state){if(1==Qt.towerTier[Jt.team])return void(this.state="UNCLICKABLE");this.isLocked=!1,S.prototype.update.call(this)}},x.prototype=Object.create(S.prototype),x.prototype.update=function(){if("LOCKED"!=this.state){if(1==Qt.ranchTier[Jt.team])return void(this.state="UNCLICKABLE");this.isLocked=!1,S.prototype.update.call(this)}},U.prototype=Object.create(S.prototype),U.prototype.update=function(){if("LOCKED"!=this.state){if(1==Qt.ranchTier[Jt.team])return void(this.state="UNCLICKABLE");this.isLocked=!1,S.prototype.update.call(this)}},z.prototype=Object.create(S.prototype),z.prototype.update=function(){if("LOCKED"!=this.state){if(1==Qt.towerTier[Jt.team])return void(this.state="UNCLICKABLE");this.isLocked=!1,S.prototype.update.call(this)}},G.prototype=Object.create(R.prototype),G.prototype.onclick=function(){if(this.toCancel){for(var t=0;t<Jt.menuBar.icons.length;++t)"ACTIVE"==Jt.menuBar.icons[t].state&&(Jt.menuBar.icons[t].cooldown=0,Jt.menuBar.icons[t].paid=!1),Jt.menuBar.icons[t].state="INACTIVE";this.state="INACTIVE",ht(jt.DESELECT,[Jt.team,this.lockedCoins]),this.lockedCoins=0,Jt.state="NONE",this.toCancel=!1}else"DESTROY"!=Jt.state?Jt.state="DESTROY":Jt.state="NONE"},G.prototype.update=function(){},H.prototype.render=function(t){if(this.isAlive&&this.team==Jt.team){if(this.delta>=this.MAX_DELTA)return void(this.isAlive=!1);t.save(),t.translate(this.pos.x-this.number.width/2,this.pos.y-this.number.height/2),this.number.render(t),this.pos.y-=1.2,t.restore(),this.delta++}},document.addEventListener("DOMContentLoaded",function(){W()});var Vt=io(),Kt={assetImageList:["asset/pig_running.png","asset/pig_standby.png","asset/pig_angry.png","asset/pig_eating.png","asset/pig_death.png","asset/boar_running.png","asset/boar_standby.png","asset/boar_attacking.png","asset/boar_eating.png","asset/boar_death.png","asset/tower.png","asset/tower_death.png","asset/castle.png","asset/castle_death.png","asset/rice_field.png","asset/rice_field_death.png","asset/super_rice_field.png","asset/pig_ranch.png","asset/pig_ranch_death.png","asset/pig_hq.png","asset/pig_hq_death.png","asset/block.png","asset/fence.png","asset/super_fence.png","asset/fence_death.png","asset/arrow.png","asset/arrow_death.png","asset/javelin.png","asset/javelin_death.png","asset/throne.png","asset/mouse.png","asset/mouse_shadow.png","asset/destroy.png","asset/tower_icon.png","asset/ranch_icon.png","asset/farm_icon.png","asset/fence_icon.png","asset/upgrade_icon.png","asset/castle_icon.png","asset/pighq_icon.png","asset/wall_icon.png","asset/farm_icon.png","asset/garden_icon.png","asset/deselect_icon.png","asset/pig_coin.png","asset/numbers.png","asset/locked_icon.png","asset/snow.png","asset/pigidow.jpg","asset/snowy-yosemite.jpg","asset/furpig-valley.jpg","asset/plus.png","asset/minus.png","asset/numbers-red.png","asset/numbers-green.png"],images:{},assetSoundList:["music/bg1.mp3","music/bg3.mp3","music/bg4.mp3","music/battle-1.mp3","music/battle-2.mp3","music/battle-3.mp3"],assetAudioList:["music/building.wav","music/oink.wav","music/start.mp3","music/destroy.wav","music/arrow.wav","music/arrow_impact.wav","music/thump.wav","music/snort.wav","music/thud.wav","music/hit-1.wav"],sounds:{},audio:{},loadedAssetCount:0,audioContext:null},jt={BUILD_TOWER:0,BUILD_FARM:1,BUILD_PIG_RANCH:2,BUILD_FENCE:3,UPGRADE_TOWER:4,UPGRADE_PIG_RANCH:5,BUY:6,DESELECT:7,BUILD_CASTLE:8,BUILD_GARDEN:9,BUILD_PIG_HQ:10,BUILD_WALL:11,SYNCHRONIZED:12,VICTORY:13,DESTROY:14},Xt={BUILD_TOWER:50,BUILD_FARM:5,BUILD_PIG_RANCH:50,BUILD_FENCE:3,UPGRADE_TOWER:600,UPGRADE_PIG_RANCH:800,BUILD_CASTLE:240,BUILD_GARDEN:35,BUILD_PIG_HQ:220,BUILD_WALL:40},qt={BACKGROUND_MONEY_RATE:300,MAX_COINS:9999,FPS:1e3/30,SCALER:1.5,SEND_DELAY:30,MAX_FLOCKS_PER_TEAM:50,ALLOWED_DELAY:300,RECOVERED_DELAY:150,CLOSE_BY:1,FAR_AWAY:2},Zt=[],Qt={},Jt={camera:[0,0],mouse:[0,0],mouseImg:null,team:0,menuBar:null,gameEventHandlerResetFunction:null,state:"NONE",appState:"LOADING_FRAME",online:[],player:{},room:{},roomList:[],playingWithId:null,currentRoom:null,isHost:!1,isGameOngoing:!1,isSinglePlayer:!0,id:0},$t={};[[[jt.BUILD_PIG_RANCH,[0,2,0]],[jt.BUILD_PIG_RANCH,[2,2,0]],[jt.BUILD_FARM,[0,4,0]],[jt.BUILD_FARM,[0,5,0]],[jt.BUILD_FARM,[0,6,0]],[jt.BUILD_FARM,[1,4,0]],[jt.BUILD_FARM,[1,5,0]],[jt.BUILD_FARM,[1,6,0]],[jt.BUILD_FARM,[2,4,0]],[jt.BUILD_FARM,[2,5,0]],[jt.BUILD_TOWER,[6,1,0]]],[[jt.BUILD_PIG_RANCH,[0,6,1]],[jt.BUILD_PIG_RANCH,[2,6,1]],[jt.BUILD_FARM,[0,8,1]],[jt.BUILD_FARM,[0,9,1]],[jt.BUILD_FARM,[0,10,1]],[jt.BUILD_FARM,[1,8,1]],[jt.BUILD_FARM,[1,9,1]],[jt.BUILD_FARM,[1,10,1]],[jt.BUILD_FARM,[2,8,1]],[jt.BUILD_FARM,[2,9,1]],[jt.BUILD_TOWER,[6,10,1]],[jt.BUILD_TOWER,[4,10,1]],[jt.BUILD_TOWER,[9,10,1]]]]}();