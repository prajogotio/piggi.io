!function(){function t(t,e){this.x=t,this.y=e}function e(t){return Math.atan2(t.y,t.x)/Math.PI*180}function i(t,e){var i=t.copy().normalize(),s=t.length(),a=Math.min(e,s);return t.x=i.x*a,t.y=i.y*a,t}function s(t){this.lessThan=t,this.size=0,this.root=null}function a(t){this.value=t,this.left=null,this.right=null,this.parent=null}function n(){this.stackIn=[],this.stackOut=[]}function o(t,e,i,a){function n(t,s,n,o,r){var c=t+n,l=s+o;if(!(0>c||0>l||c>=i.height||l>=i.width)){var d=c*i.width+l,u=Math.abs(e[0]-c)+Math.abs(e[1]-l);if(a)for(var m=0;m<a.length;++m){var g=Math.abs(a[m][0]-c)+Math.abs(a[m][1]-l);u>g&&(u=g)}h[d]>0||0!=i.data[d]&&p.push({cost:r+1+u,par:t*i.width+s,dist:r+1,pos:[c,l]})}}if(t[0]<0||t[1]<0||t[0]>=i.height||t[1]>=i.width||e[0]<0||e[1]<0||e[0]>=i.height||e[1]>=i.width)return[];if(a){for(var o=[],r=0;r<a.length;++r)0!=i.data[a[r][0]*i.width+a[r][1]]&&o.push(a[r]);a=o}var h=new Int32Array(i.data.length),c=new Int32Array(i.data.length).fill(-1),l=function(t,e){return t.cost<e.cost},p=new s(l);h[i.width*t.row+t.col]=1,p.push({cost:0,dist:0,par:-1,pos:t});for(var d=-1,u=1e9;p.size>0;){var m=p.top();p.pop();var g=m.pos[0],f=m.pos[1],y=m.dist,E=g*i.width+f;if(!h[E]){h[E]=1,c[E]=m.par;var v=Math.abs(e[0]-g)+Math.abs(e[1]-f);if(u>=v&&(u=v,d=E),g==e[0]&&f==e[1]){d=E;break}if(a){for(var A=!1,r=0;r<a.length;++r)if(a[r][0]==g&&a[r][1]==f){d=E,A=!0;break}if(A)break}n(g,f,-1,0,y),n(g,f,1,0,y),n(g,f,0,-1,y),n(g,f,0,1,y)}}var I=[];if(-1!=d)for(;-1!=d;){var g=Math.floor(d/i.width),f=d-g*i.width;I.push([g,f]),d=c[d]}return I}function r(e,i){for(var s=[],a=0;a<e.length;++a)s.push(new t((e[a][1]+.5)*i.size,(e[a][0]+.5)*i.size));return s}function h(t,e,i,s,a,n,o){this.DELTA_PER_FRAME=Math.ceil(o/Yt.SCALER),this.delta=0,this.currentFrame=0,this.numOfFrames=n,this.imgBuffer=t,this.offsetX=e,this.offsetY=i,this.width=s,this.height=a,this.autoReset=!0}function c(e,i,s){this.STANDBY=0,this.MOVING=1,this.ATTACKING=2,this.EATING=3,this.DEAD=4,this.FLOCK_AGGRESIVENESS=200,this.BUILDING_AGGRESIVENESS=640,this.RADIUS_OF_ACCEPTANCE=4,this.MAXIMUM_SPEED=1.5*Yt.SCALER,this.AVOIDANCE_SPEED=1.5*Yt.SCALER,this.TARGET_RADIUS=64,this.steeringEffect=2.4*Yt.SCALER,this.attackRadius=32,this.MOVING_TARGET=!0,this.mass=e,this.radius=s||32,this.invMass=0==e?0:1/e,this.pos=i,this.force=new t(0,0),this.steeringForce=new t(0,0),this.velocity=new t(0,0),this.orientation=0,this.target=null,this.targetStack=[],this.pathTimestamp=-1,this.state=this.STANDBY,this.ENVIRONMENT_CHECK_DELAY=80,this.lastEnvironmentCheck=-10,this.updateCount=0,this.lockOnTarget=null,this.lastAttack=0,this.ATTACK_DELAY=80/Yt.SCALER,this.team=0,this.healthPoints=100,this.isAlive=!0,this.strength=30,this.maxHealthPoints=100,this.provoked=!1,this.PERSISTENCE=1e3/Yt.SCALER,this.timeOfDeath=-1,this.INTEGRATE_ONLY_MAX_COUNTER=10/Yt.SCALER,this.integrateOnlyCounter=10/Yt.SCALER}function l(t,e,i){c.call(this,t,e,i),this.sprites={}}function p(e,i){this.size=e,this.radius=e/2,this.pos=new t(0,0),this.row=null,this.col=null,this.NORMAL=0,this.DEAD=1,this.ATTACK_TYPE=0,this.EAT_TYPE=1,this.NO_INTERACTION=2,this.SHOW_HEALTHBAR=!0,this.MOVING_TARGET=!1,this.ACTIVE=0,this.PASSIVE=1,this.sprites={},this.state=this.NORMAL,this.interactionDistance=i,this.interactionType=this.ATTACK_TYPE,this.activity=this.ACTIVE,this.MAX_INTERACTION=6,this.interactionCount=0,this.attackRadius=500,this.ATTACK_DELAY=130,this.strength=80,this.lastAttack=0,this.team=0,this.healthPoints=500,this.maxHealthPoints=500,this.isAlive=!0,this.updateCount=0,this.PERSISTENCE=120,this.timeOfDeath=-1,this.destroyable=!0}function d(t,e){l.call(this,100,t,32),this.setSprite(this.STANDBY,new h(zt.images[R("asset/pig_standby.png",e)],0,0,128,128,4,20)),this.setSprite(this.MOVING,new h(zt.images[R("asset/pig_running.png",e)],0,0,128,128,6,12)),this.setSprite(this.ATTACKING,new h(zt.images[R("asset/pig_angry.png",e)],0,0,128,128,3,20)),this.setSprite(this.EATING,new h(zt.images[R("asset/pig_eating.png",e)],0,0,128,128,2,30)),this.setSprite(this.DEAD,new h(zt.images[R("asset/pig_death.png",e)],0,0,128,128,1,100)),this.sprites[this.ATTACKING].autoReset=!1,this.team=e,this.healthPoints=this.maxHealthPoints=200,this.strength=30}function u(t,e){l.call(this,100,t,32),this.setSprite(this.STANDBY,new h(zt.images[R("asset/boar_standby.png",e)],0,0,128,128,2,30)),this.setSprite(this.MOVING,new h(zt.images[R("asset/boar_running.png",e)],0,0,128,128,10,12)),this.setSprite(this.ATTACKING,new h(zt.images[R("asset/boar_attacking.png",e)],0,0,128,128,3,20)),this.setSprite(this.EATING,new h(zt.images[R("asset/boar_eating.png",e)],0,0,128,128,2,30)),this.setSprite(this.DEAD,new h(zt.images[R("asset/boar_death.png",e)],0,0,128,128,1,100)),this.sprites[this.ATTACKING].autoReset=!1,this.team=e,this.healthPoints=this.maxHealthPoints=1200,this.strength=180,this.ATTACK_DELAY=60}function m(t,e,i){p.call(this,128,640),this.setSprite(this.NORMAL,new h(zt.images[R("asset/tower.png",i)],0,0,128,128,2,25)),this.setSprite(this.DEAD,new h(zt.images[R("asset/tower_death.png",i)],0,0,128,128,1,100)),w(this,Kt.map,t,e),this.type=this.ATTACK_TYPE,this.attackRadius=300,this.ATTACK_DELAY=200/Yt.SCALER,this.healthPoints=this.maxHealthPoints=500,this.strength=80,this.team=i,this.MAX_INTERACTION=12,this.weapon=L}function g(t,e,i){p.call(this,128,640),this.setSprite(this.NORMAL,new h(zt.images[R("asset/castle.png",i)],0,0,128,128,2,25)),this.setSprite(this.DEAD,new h(zt.images[R("asset/castle_death.png",i)],0,0,128,128,1,100)),w(this,Kt.map,t,e),this.type=this.ATTACK_TYPE,this.attackRadius=400,this.ATTACK_DELAY=120/Yt.SCALER,this.strength=250,this.healthPoints=this.maxHealthPoints=1800,this.team=i,this.MAX_INTERACTION=12,this.weapon=_}function f(t,e,i){p.call(this,64,128),this.setSprite(this.NORMAL,new h(zt.images[R("asset/rice_field.png",i)],0,0,128,128,6,200)),this.setSprite(this.DEAD,new h(zt.images[R("asset/rice_field_death.png",i)],0,0,128,128,1,100)),w(this,Kt.map,t,e),Kt.map.data[t*Kt.map.width+e]=1,this.team=i,this.interactionType=this.EAT_TYPE,this.SHOW_HEALTHBAR=!1,this.healthPoints=200,this.PERSISTENCE=300/Yt.SCALER,this.MAX_INTERACTION=2,this.radius=0,this.coinsToHarvest=1,this.lastProduce=0,this.PRODUCE_DELAY=200/Yt.SCALER}function y(t,e,i){p.call(this,64,128),this.setSprite(this.NORMAL,new h(zt.images[R("asset/super_rice_field.png",i)],0,0,128,128,6,200)),this.setSprite(this.DEAD,new h(zt.images[R("asset/rice_field_death.png",i)],0,0,128,128,1,100)),w(this,Kt.map,t,e),Kt.map.data[t*Kt.map.width+e]=1,this.team=i,this.interactionType=this.EAT_TYPE,this.SHOW_HEALTHBAR=!1,this.healthPoints=550,this.PERSISTENCE=300/Yt.SCALER,this.MAX_INTERACTION=2,this.radius=0,this.coinsToHarvest=3,this.PRODUCE_DELAY=250/Yt.SCALER}function E(t,e,i){p.call(this,64,100),this.setSprite(this.NORMAL,new h(zt.images[R("asset/fence.png",i)],0,0,128,128,1,100)),this.setSprite(this.DEAD,new h(zt.images[R("asset/fence_death.png",i)],0,0,128,128,1,100)),w(this,Kt.map,t,e),this.team=i,this.type=this.ATTACK_TYPE,this.activity=this.PASSIVE,this.SHOW_HEALTHBAR=!1,this.PERSISTENCE=20,this.healthPoints=100,this.MAX_INTERACTION=2}function v(t,e,i){p.call(this,64,100),this.setSprite(this.NORMAL,new h(zt.images[R("asset/super_fence.png",i)],0,0,128,128,1,100)),this.setSprite(this.DEAD,new h(zt.images[R("asset/fence_death.png",i)],0,0,128,128,1,100)),w(this,Kt.map,t,e),this.team=i,this.type=this.ATTACK_TYPE,this.activity=this.PASSIVE,this.SHOW_HEALTHBAR=!1,this.PERSISTENCE=20,this.healthPoints=this.maxHealthPoints=400,this.MAX_INTERACTION=2}function A(t,e,i){p.call(this,128,300),this.setSprite(this.NORMAL,new h(zt.images[R("asset/pig_ranch.png",i)],0,0,128,128,2,100)),this.setSprite(this.DEAD,new h(zt.images[R("asset/pig_ranch_death.png",i)],0,0,128,128,1,100)),w(this,Kt.map,t,e),this.team=i,this.type=this.ATTACK_TYPE,this.healthPoints=350,this.maxHealthPoints=350,this.MAX_INTERACTION=8,this.lastProduce=0,this.PRODUCE_DELAY=600/Yt.SCALER,this.pigsPerProduction=1,this.product=d,this.productPrice=20}function I(t,e,i){p.call(this,128,300),this.setSprite(this.NORMAL,new h(zt.images[R("asset/pig_hq.png",i)],0,0,128,128,2,100)),this.setSprite(this.DEAD,new h(zt.images[R("asset/pig_hq_death.png",i)],0,0,128,128,1,100)),w(this,Kt.map,t,e),this.team=i,this.type=this.ATTACK_TYPE,this.healthPoints=this.maxHealthPoints=1250,this.MAX_INTERACTION=8,this.lastProduce=0,this.PRODUCE_DELAY=600/Yt.SCALER,this.pigsPerProduction=1,this.product=u,this.productPrice=200}function T(t,e,i){p.call(this,128,1e3),this.setSprite(this.NORMAL,new h(zt.images[R("asset/throne.png",i)],0,0,128,128,6,40)),this.setSprite(this.DEAD,new h(zt.images[R("asset/throne.png",i)],0,0,128,128,1,100)),w(this,Kt.map,t,e),this.team=i,this.type=this.ATTACK_TYPE,this.SHOW_HEALTHBAR=!0,this.PERSISTENCE=700,this.healthPoints=this.maxHealthPoints=5e3,this.MAX_INTERACTION=1e4,this.destroyable=!1}function L(t,i,s){l.call(this,0,t.pos.copy(),32),this.setSprite(this.STANDBY,new h(zt.images[R("asset/arrow.png",t.team)],0,0,128,128,1,100)),this.setSprite(this.DEAD,new h(zt.images[R("asset/arrow_death.png",t.team)],0,0,128,128,1,100)),this.target=i,this.owner=t,this.startPoint=t.pos.copy(),this.destination=i.pos.copy(),this.damage=s,this.orientation=e(i.pos.minus(t.pos)),this.updateCount=0,this.maxDelta=40/Yt.SCALER}function _(t,i,s){l.call(this,0,t.pos.copy(),45),this.setSprite(this.STANDBY,new h(zt.images[R("asset/javelin.png",t.team)],0,0,128,128,1,100)),this.setSprite(this.DEAD,new h(zt.images[R("asset/javelin_death.png",t.team)],0,0,128,128,1,100)),this.target=i,this.owner=t,this.startPoint=t.pos.copy(),this.destination=i.pos.copy(),this.damage=s,this.orientation=e(i.pos.minus(t.pos)),this.updateCount=0,this.maxDelta=40/Yt.SCALER}function w(t,e,i,s){for(var a=Math.floor(t.size/e.size),n=0;a>n;++n)for(var o=0;a>o;++o)e.data[(i+n)*e.width+s+o]=0,e.entry[(i+n)*e.width+s+o]=t;t.pos.x=(s+a/2)*e.size,t.pos.y=(i+a/2)*e.size,t.row=i,t.col=s,e.lastUpdated=Kt.timestep}function k(t,e){for(var i=Math.floor(t.size/e.size),s=0;i>s;++s)for(var a=0;i>a;++a)e.data[(t.row+s)*e.width+t.col+a]=1,e.entry[(t.row+s)*e.width+t.col+a]=null;e.lastUpdated=Kt.timestep}function R(t,e){return e!=Wt.team&&(t+="/b"),t}function C(){this.currentState="BUILD",this.icons=[];var t=[S,M,B,b,P,N,U,G,x,z];this.ICON_SIZE=80;for(var e=0;2>e;++e)for(var i=0;5>i;++i)this.icons.push(new t[5*e+i]((this.ICON_SIZE+2)*i+this.ICON_SIZE/2+3,(this.ICON_SIZE+2)*e+3+this.ICON_SIZE/2,this.ICON_SIZE));this.tower=this.icons[0],this.ranch=this.icons[1],this.farm=this.icons[2],this.fence=this.icons[3],this.upgrade=this.icons[4],this.castle=this.icons[5],this.pighq=this.icons[6],this.garden=this.icons[7],this.wall=this.icons[8],this.deselect=this.icons[9],this.coinInfoSize=40,this.width=5*(this.ICON_SIZE+2)+4,this.height=2*(this.ICON_SIZE+2)+4,this.updatePosition()}function O(t,e,i,s){this.sprite=new h(t,0,0,128,128,1,100),this.state="INACTIVE",this.x=e,this.y=i,this.width=s,this.height=s,this.isLocked=!1}function D(t,e,i,s,a){O.call(this,t,e,i,s),this.commandType=a,this.isAlive=!0,this.buildingSize=1}function S(t,e,i){D.call(this,zt.images["asset/tower_icon.png"],t,e,i,"BUILD_TOWER"),this.buildingSize=2,this.tier=Kt.towerTier,this.tierCommand="UPGRADE_TOWER"}function M(t,e,i){D.call(this,zt.images["asset/ranch_icon.png"],t,e,i,"BUILD_PIG_RANCH"),this.buildingSize=2,this.tier=Kt.ranchTier,this.tierCommand="UPGRADE_PIG_RANCH"}function B(t,e,i){D.call(this,zt.images["asset/farm_icon.png"],t,e,i,"BUILD_FARM"),this.buildingSize=1}function b(t,e,i){D.call(this,zt.images["asset/fence_icon.png"],t,e,i,"BUILD_FENCE"),this.buildingSize=1}function P(t,e,i){O.call(this,zt.images["asset/upgrade_icon.png"],t,e,i)}function N(t,e,i){D.call(this,zt.images["asset/castle_icon.png"],t,e,i,"BUILD_CASTLE"),this.buildingSize=2,this.isLocked=!0}function U(t,e,i){D.call(this,zt.images["asset/pighq_icon.png"],t,e,i,"BUILD_PIG_HQ"),this.buildingSize=2,this.isLocked=!0}function G(t,e,i){D.call(this,zt.images["asset/garden_icon.png"],t,e,i,"BUILD_GARDEN"),this.buildingSize=1,this.isLocked=!0}function x(t,e,i){D.call(this,zt.images["asset/wall_icon.png"],t,e,i,"BUILD_WALL"),this.buildingSize=1,this.isLocked=!0}function z(t,e,i){O.call(this,zt.images["asset/deselect_icon.png"],t,e,i),this.state="INACTIVE",this.lockedCoins=0,this.toCancel=!1}function F(t,e){for(var i=[];t>0;)i.push(t%10),t=Math.floor(t/10);0==i.length&&(i=[0]),i.reverse();var s=.5*e;return{render:function(t){for(var a=0;a<i.length;++a)t.drawImage(zt.images["asset/numbers.png"],128*i[a],0,128,128,a*s-(e-s)/2,0,e,e)},width:s*i.length,height:e}}function H(){Wt.canvas=document.getElementById("canvas"),Wt.g=Wt.canvas.getContext("2d"),jt.LOADING_FRAME=document.getElementById("loading-frame"),jt.LOGIN_FRAME=document.getElementById("login-frame"),jt.LOBBY_FRAME=document.getElementById("lobby-frame"),jt.ROOM_FRAME=document.getElementById("room-frame"),jt.GAME_FRAME=document.getElementById("game-frame"),Y()}function Y(){for(var t=3,e=0;e<zt.assetImageList.length;++e){var i=new Image;zt.images[zt.assetImageList[e]]=i,i.onload=function(e){return function(){zt.loadedAssetCount++;var i=document.createElement("canvas");i.width=zt.images[e].width,i.height=zt.images[e].height;var s=i.getContext("2d");s.save(),s.drawImage(zt.images[e],0,0,zt.images[e].width,zt.images[e].height,0,0,zt.images[e].width,zt.images[e].height);for(var a=s.getImageData(0,0,i.width,i.height),n=0;n<a.data.length;n+=4)a.data[n]-a.data[n+1]<=t&&a.data[n+1]-a.data[n+2]<=t&&(a.data[n]<100||a.data[n+3]<255)||(a.data[n]=Math.min(255,1.1*a.data[n]),a.data[n+1]=Math.min(255,1.3*a.data[n+1]),a.data[n+2]=Math.min(255,.8*a.data[n+2]));s.putImageData(a,0,0),s.restore(),zt.images[e+"/b"]=i,V()}}(zt.assetImageList[e]),i.src=zt.assetImageList[e]}}function V(){var t=document.getElementById("loading-caption");t.innerHTML=Math.floor(zt.loadedAssetCount/(zt.assetImageList.length+zt.assetSoundList.length)*100)+"%",zt.loadedAssetCount==zt.assetImageList.length+zt.assetSoundList.length&&K()}function K(){canvas.width=window.innerWidth,canvas.height=window.innerHeight,Wt.mouseImg=zt.images["asset/mouse.png"],Wt.mouseShadowImg=zt.images["asset/mouse_shadow.png"],Wt.mouse[0]=Wt.canvas.width/2,Wt.mouse[1]=Wt.canvas.height/2,Bt(),tt(),kt(),ct("LOGIN_FRAME")}function W(){Kt.scheduler&&clearInterval(Kt.scheduler),Kt.gameEventHandlerResetFunction&&Kt.gameEventHandlerResetFunction(),Kt={},jt.GAME_FRAME.style.setProperty("display","block"),j(Wt.currentRoom.chosenMap),Wt.menuBar=new C,Wt.camera[0]=Kt.thrones[Wt.team].pos.x-Wt.canvas.width/2,Wt.camera[1]=Kt.thrones[Wt.team].pos.y-Wt.canvas.height/2,Wt.gameEventHandlerResetFunction=et(),Lt(),Kt.snapshot.timestep=-1,Kt.scheduler=setInterval(function(){Kt.isGameOver||(ot(),J()),X(),q(),rt(),Z(),Kt.isGameOver||Tt()},Yt.FPS)}function j(t){var e=Vt[t],i=e.width,s=e.height,a=e.asset,n={map:{width:i,height:s,data:new Int32Array(i*s).fill(1),entry:new Array(i*s).fill(null),imgBuffer:zt.images[a],size:64,lastUpdated:0,specialEffect:e.specialEffect?e.specialEffect():null},deadflocks:[],deadarrows:[],deadbuildings:[],flocks:[],buildings:[],arrows:[],timestep:0,thrones:[],ranchTier:[1,1],towerTier:[1,1],coins:[10,10],lastSynchronized:-1,lastSent:0,localCommandLog:[],commandBackLog:[[],[]],declaredVictory:[!1,!1],isGameOver:!1,madeDeclaration:!1};Kt=n;for(var o=0;o<e.thrones.length;++o)n.thrones.push(new T(e.thrones[o][0],e.thrones[o][1],o))}function X(){var t=Wt.mouse,e=Wt.camera,i=10*Yt.SCALER,s=4;t[0]<=s&&(e[0]-=i),t[0]>=canvas.width-s-32&&(e[0]+=i),t[1]<=s&&(e[1]-=i),t[1]>=canvas.height-s-32&&(e[1]+=i);var a=180,n=Math.max(0,(Wt.canvas.width-Kt.map.height*Kt.map.size)/2),o=Math.max(0,(Wt.canvas.width-Kt.map.width*Kt.map.size)/2);e[0]<-o&&(e[0]=-o),e[1]<-n&&(e[1]=-n),e[0]=Math.min(e[0],Kt.map.size*Kt.map.width+o-Wt.canvas.width),e[1]=Math.min(e[1],Kt.map.size*Kt.map.height+a+n-Wt.canvas.height)}function q(){var t=Wt.g,e=Wt.camera,i=Wt.canvas,s=Kt.map;t.clearRect(0,0,i.width,i.height),t.fillStyle="rgba(0,0,0,0.8)",t.fillRect(0,0,i.width,i.height),t.drawImage(s.imgBuffer,Math.max(0,e[0]),Math.max(0,e[1]),Math.min(i.width,e[0]+i.width),Math.min(i.height,e[1]+i.height),Math.max(0,-e[0]),Math.max(0,-e[1]),Math.min(i.width,e[0]+i.width),Math.min(i.height,e[1]+i.height)),t.save(),t.translate(-e[0],-e[1]);for(var a=[Kt.thrones,Kt.deadbuildings,Kt.buildings,Kt.deadflocks,Kt.deadarrows,Kt.flocks,Kt.arrows],n=0;n<a.length;++n)for(var o=0;o<a[n].length;++o)a[n][o].render(t);Kt.map.specialEffect&&Kt.map.specialEffect(t),t.restore(),Q(t)}function Z(){Wt.mouseTrapped||Dt("Click on the screen to move the piggi mouse.");var t=Wt.g;t.save(),t.translate(Wt.mouse[0],Wt.mouse[1]),t.save(),t.globalAlpha=.2,t.drawImage(Wt.mouseShadowImg,0,0,128,128,3,10,30,30),t.restore(),"DESTROY"==Wt.state?t.drawImage(zt.images["asset/destroy.png"],0,0,128,128,0,0,32,32):t.drawImage(Wt.mouseImg,0,0,128,128,0,0,32,32),t.restore()}function Q(t){if("BUILDING"==Wt.state){var e=st(Wt.mouse[0]+Wt.camera[0],Wt.mouse[1]+Wt.camera[1]);t.save(),t.fillStyle=it(e[0],e[1],Wt.buildingSize)?"red":"green",t.globalAlpha=.5,t.fillRect(e[1]*Kt.map.size-Wt.camera[0],e[0]*Kt.map.size-Wt.camera[1],Wt.buildingSize*Kt.map.size,Wt.buildingSize*Kt.map.size),t.restore()}else if("DESTROY"==Wt.state){var e=st(Wt.mouse[0]+Wt.camera[0],Wt.mouse[1]+Wt.camera[1]);t.save(),t.fillStyle=Mt(e[0],e[1],Wt.team)?"green":"red",t.globalAlpha=.5,t.fillRect(e[1]*Kt.map.size-Wt.camera[0],e[0]*Kt.map.size-Wt.camera[1],Kt.map.size,Kt.map.size),t.restore()}}function J(){if(Kt.timestep%Yt.BACKGROUND_MONEY_RATE==0)for(var t=0;t<Kt.coins.length;++t)Kt.coins[t]+=1;for(var e=[Kt.deadbuildings,Kt.deadflocks,Kt.deadarrows,Kt.flocks,Kt.buildings,Kt.arrows,Kt.thrones],t=0;t<e.length;++t)for(var i=0;i<e[t].length;++i)e[t][i].update(Kt.flocks,Kt.map);$();for(var t=0;t<Kt.coins.length;++t)Kt.coins[t]=Math.min(Kt.coins[t],Yt.MAX_COINS);if(Kt.timestep!=Kt.lastSynchronized||Wt.isSinglePlayer||Lt(),Kt.snapshot&&(Kt.snapshot.declaredVictory[0]||Kt.snapshot.declaredVictory[1]))return void Rt();if(Wt.isSinglePlayer&&(Kt.thrones[0].isAlive||(Kt.declaredVictory[1]=!0),Kt.thrones[1].isAlive||(Kt.declaredVictory[0]=!0),Kt.declaredVictory[0]||Kt.declaredVictory[1]))return void Rt();Kt.timestep++;var s=(Wt.team+1)%2;Kt.thrones[s].isAlive||Kt.madeDeclaration||(Kt.madeDeclaration=!0,at(Ft.VICTORY,[Wt.team]))}function $(){for(var t=[],e=0;e<Kt.deadflocks.length;++e)Kt.deadflocks[e].garbageCollectible()?Kt.deadflocks[e].cleanUp(Kt.flocks,Kt.map):t.push(Kt.deadflocks[e]);Kt.deadflocks=t,t=[];for(var e=0;e<Kt.deadarrows.length;++e)Kt.deadarrows[e].garbageCollectible()?Kt.deadarrows[e].cleanUp(Kt.flocks,Kt.map):t.push(Kt.deadarrows[e]);Kt.deadarrows=t,t=[];for(var e=0;e<Kt.deadbuildings.length;++e)Kt.deadbuildings[e].garbageCollectible()?Kt.deadbuildings[e].cleanUp(Kt.flocks,Kt.map):t.push(Kt.deadbuildings[e]);Kt.deadbuildings=t,t=[];for(var e=0;e<Kt.flocks.length;++e)Kt.flocks[e].isAlive?t.push(Kt.flocks[e]):Kt.deadflocks.push(Kt.flocks[e]);Kt.flocks=t,t=[];for(var e=0;e<Kt.arrows.length;++e)Kt.arrows[e].isAlive?t.push(Kt.arrows[e]):Kt.deadarrows.push(Kt.arrows[e]);Kt.arrows=t,t=[];for(var e=0;e<Kt.buildings.length;++e)Kt.buildings[e].isAlive?t.push(Kt.buildings[e]):Kt.deadbuildings.push(Kt.buildings[e]);Kt.buildings=t}function tt(){function t(){return document.pointerLockElement===a||document.mozPointerLockElement===a||document.webkitPointerLockElement===a}function e(){t()?(St(),document.addEventListener("mousemove",i,!1),Wt.mouse=[a.width/2,a.height/2],Wt.mouseTrapped=!0):(document.removeEventListener("mousemove",i,!1),Wt.mouseTrapped=!1)}function i(t){var e=Wt.mouse,i=(Wt.camera,t.movementX);movementY=t.movementY,e[0]=Math.min(Math.max(0,e[0]+1.2*i),a.width-32),e[1]=Math.min(Math.max(0,e[1]+1.2*movementY),a.height-32)}function s(e){t()||(a.requestPointerLock=a.requestPointerLock||a.mozRequestPointerLock||a.webkitRequestPointerLock,a.requestPointerLock())}var a=(Wt.camera,Wt.canvas);Kt.map;a.addEventListener("mousedown",s),document.addEventListener("pointerlockchange",e,!1),document.addEventListener("mozpointerlockchange",e,!1),document.addEventListener("webkitpointerlockchange",e,!1);var n=document.getElementById("login-input");n.addEventListener("keydown",function(t){if(13==t.which){var e=n.value;return xt.emit("login-name",e),ct("LOBBY_FRAME"),!1}}),document.getElementById("create-room").addEventListener("click",function(){document.getElementById("create-room-form").style.display="block",document.getElementById("room-title").value="",document.getElementById("room-title").focus()}),document.getElementById("create-room-cancel").onclick=function(){document.getElementById("create-room-form").style.display="none"},document.getElementById("room-title").addEventListener("keydown",function(t){return 13==t.which?(lt(document.getElementById("room-title").value),document.getElementById("create-room-form").style.display="none",!1):void 0}),document.getElementById("create-room-submit").addEventListener("click",function(t){lt(document.getElementById("room-title").value),document.getElementById("create-room-form").style.display="none"}),document.getElementById("start-game-button").addEventListener("click",function(){Wt.isHost&&(Wt.currentRoom.isSinglePlayer?Ut():(xt.emit("request-start-game"),vt()))}),document.getElementById("exit-button").addEventListener("click",function(){Wt.isHost=!1,xt.emit("exit-room"),ct("LOBBY_FRAME")}),document.getElementById("prev-map").addEventListener("click",function(){var t=Wt.currentRoom.chosenMap-1;0>t&&(t+=Vt.length),Wt.currentRoom.chosenMap=t,Wt.currentRoom.isSinglePlayer||xt.emit("map-change",t),It()}),document.getElementById("next-map").addEventListener("click",function(){var t=(Wt.currentRoom.chosenMap+1)%Vt.length;Wt.currentRoom.chosenMap=t,Wt.currentRoom.isSinglePlayer||xt.emit("map-change",t),It()}),document.getElementById("tutorial").addEventListener("click",function(){Pt()}),document.getElementById("single-player").addEventListener("click",function(){Wt.currentRoom={id:0,title:"Single Player",chosenMap:0,isSinglePlayer:!0,hostId:Wt.id},Wt.isHost=!0,ct("ROOM_FRAME")}),document.getElementById("tutorial-ok-button").addEventListener("click",function(){Nt()}),xt.on("id",function(t){Wt.id=t}),xt.on("online",function(t){Wt.online.push(t.id),Wt.player[t.id]=t,mt(t)}),xt.on("new-room",function(t){Wt.room[t.id]=t,Wt.roomList.push(t.id),pt(t)}),xt.on("room-list",function(t){Wt.roomList=[],Wt.room={};for(var e=0;e<t.length;++e)Wt.roomList.push(t[e].id),Wt.room[t[e].id]=t[e];pt()}),xt.on("online-player",function(t){Wt.online=[];for(var e=0;e<t.length;++e)Wt.online.push(t[e].id),Wt.player[t[e].id]=t[e];mt()}),xt.on("offline",function(t){ft(t),mt()}),xt.on("room-created",function(t){Wt.room[t.id]=t,Wt.roomList.push(t.id),Wt.currentRoom=t,Wt.isHost=!0,Wt.currentRoom.chosenMap=0,ct("ROOM_FRAME")}),xt.on("room-full",function(t){Wt.room[t].full=!0,ut(Wt.room[t]),Wt.enteringRoomId==msg&&Et("Room is currently full")}),xt.on("room-available",function(t){Wt.room[t].full=!1,ut(Wt.room[t])}),xt.on("room-exited",function(t){Wt.currentRoom&&Wt.currentRoom.guestId==t&&(Wt.currentRoom.guestId=-1,It())}),xt.on("room-unavailable",function(t){Wt.enteringRoomId==t&&(Et("Room is currently unavailable"),At())}),xt.on("room-joined",function(t){t.id==Wt.enteringRoomId&&(Wt.room[t.id]=t,Wt.currentRoom=t,Wt.currentRoom.guestId=Wt.id,Wt.playingWithId=Wt.currentRoom.hostId,ct("ROOM_FRAME"),At())}),xt.on("room-visitor",function(t){guestId=t.id,username=t.username,Wt.currentRoom&&(Wt.currentRoom.guestId=guestId,Wt.player[guestId]={username:username,id:guestId},Wt.playingWithId=guestId,It())}),xt.on("map-change",function(t){Wt.currentRoom.chosenMap=t,It()}),xt.on("room-deleted",function(t){for(var e=[],i=0;i<Wt.roomList.length;++i){var s=Wt.roomList[i];s!=t&&e.push(s)}Wt.roomList=e,delete Wt.room[t],pt()}),xt.on("room-owner",function(t){Wt.currentRoom&&Wt.currentRoom.id==t&&(Wt.isHost=!0,Wt.currentRoom.guestId=-1,Wt.currentRoom.hostId=Wt.id,It())}),xt.on("start-game",function(t){Wt.isHost?Wt.team=t.host:Wt.team=t.guest,Wt.isGameOngoing=!0,Wt.isSinglePlayer=!1,ct("GAME_FRAME"),At(),W()}),xt.on("commands",function(t){Wt.isGameOngoing&&wt(t)})}function et(){function t(t){var e=Wt.mouse[0]+Wt.camera[0],i=Wt.mouse[1]+Wt.camera[1],s=Wt.mouse[0],a=Wt.mouse[1];if(1==t.buttons){if(Wt.menuBar.containsPoint(s,a))return void Wt.menuBar.onclick(s,a);if("BUILDING"==Wt.state){var n=st(e,i);it(n[0],n[1],Wt.buildingSize)||(Wt.state="NONE",Wt.menuBar.reset(),at(Wt.currentCommand,[n[0],n[1],Wt.team]))}else if("DESTROY"==Wt.state){var n=st(e,i);Mt(n[0],n[1],Wt.team)&&(Wt.state="NONE",at(Ft.DESTROY,[n[0],n[1],Wt.team]),Wt.menuBar.reset())}}else 2==t.buttons&&("BUILDING"==Wt.state||"DESTROY"==Wt.state)&&Wt.menuBar.deselect.onclick()}function e(t){Wt.mouse[0]+Wt.camera[0],Wt.mouse[1]+Wt.camera[1];84==t.which?Wt.menuBar.tower.onclick():65==t.which?Wt.menuBar.farm.onclick():70==t.which?Wt.menuBar.fence.onclick():82==t.which?Wt.menuBar.ranch.onclick():67==t.which?Wt.menuBar.castle.onclick():72==t.which?Wt.menuBar.pighq.onclick():71==t.which?Wt.menuBar.garden.onclick():87==t.which?Wt.menuBar.wall.onclick():85==t.which?Wt.menuBar.upgrade.onclick():68==t.which&&Wt.menuBar.deselect.onclick()}var i=(Wt.camera,Wt.canvas);Kt.map;return i.addEventListener("mousedown",t),document.addEventListener("keydown",e),function(){document.removeEventListener("mousedown",t),document.removeEventListener("keydown",e)}}function it(t,e,i){for(var s=0;i>s;++s)for(var a=0;i>a;++a){if(0>t+s||0>e+a||t+s>=Kt.map.height||e+a>=Kt.map.width)return!0;if(Kt.map.entry[(t+s)*Kt.map.width+(e+a)])return!0}for(var s=0;s<Kt.flocks.length;++s)for(var n=0;i>n;++n)for(var o=0;i>o;++o)if(Kt.flocks[s].collidesWithCell(Kt.map,[t+n,e+o]))return!0;return!1}function st(t,e){return[Math.floor(e/Kt.map.size),Math.floor(t/Kt.map.size)]}function at(t,e){Kt.localCommandLog.push([Kt.timestep,t,e]),Kt.commandBackLog[Wt.team].push([Kt.timestep,t,e])}function nt(t,e){var i=(t[0],t[1]),s=t[2];if(i==Ft.BUILD_TOWER){if(it(s[0],s[1],2))return void(Kt.coins[s[2]]+=Ht.BUILD_TOWER);Kt.buildings.push(new m(s[0],s[1],s[2]))}else if(i==Ft.BUILD_FARM){if(it(s[0],s[1],1))return void(Kt.coins[s[2]]+=Ht.BUILD_FARM);Kt.buildings.push(new f(s[0],s[1],s[2]))}else if(i==Ft.BUILD_FENCE){if(it(s[0],s[1],1))return void(Kt.coins[s[2]]+=Ht.BUILD_FENCE);Kt.buildings.push(new E(s[0],s[1],s[2]))}else if(i==Ft.BUILD_PIG_RANCH){if(it(s[0],s[1],2))return void(Kt.coins[s[2]]+=Ht.BUILD_PIG_RANCH);Kt.buildings.push(new A(s[0],s[1],s[2]))}else if(i==Ft.BUILD_CASTLE){if(it(s[0],s[1],2))return void(Kt.coins[s[2]]+=Ht.BUILD_CASTLE);Kt.buildings.push(new g(s[0],s[1],s[2]))}else if(i==Ft.BUILD_GARDEN){if(it(s[0],s[1],1))return void(Kt.coins[s[2]]+=Ht.BUILD_GARDEN);Kt.buildings.push(new y(s[0],s[1],s[2]))}else if(i==Ft.BUILD_WALL){if(it(s[0],s[1],1))return void(Kt.coins[s[2]]+=Ht.BUILD_WALL);Kt.buildings.push(new v(s[0],s[1],s[2]))}else if(i==Ft.BUILD_PIG_HQ){if(it(s[0],s[1],2))return void(Kt.coins[s[2]]+=Ht.BUILD_PIG_HQ);Kt.buildings.push(new I(s[0],s[1],s[2]))}else if(i==Ft.UPGRADE_PIG_RANCH){if(2==Kt.ranchTier[s[0]])return;if(Kt.coins[s[0]]<Ht.UPGRADE_PIG_RANCH)return;Kt.coins[s[0]]-=Ht.UPGRADE_PIG_RANCH,Kt.ranchTier[s[0]]=2}else if(i==Ft.UPGRADE_TOWER){if(2==Kt.towerTier[s[0]])return;if(Kt.coins[s[0]]<Ht.UPGRADE_TOWER)return;Kt.coins[s[0]]-=Ht.UPGRADE_TOWER,Kt.towerTier[s[0]]=2}else if(i==Ft.BUY){var a=s[0],n=s[1],o=s[2];Kt.coins[a]>=o&&(Kt.coins[a]-=o,ht(a)&&!e&&(Wt.currentCommand=n,Wt.state="BUILDING",Wt.buildingSize=s[3]))}else if(i==Ft.DESELECT)Kt.coins[s[0]]+=s[1];else if(i==Ft.SYNCHRONIZED)Kt.lastSynchronized=Kt.timestep;else if(i==Ft.VICTORY){var r=(s[0]+1)%2;if(Kt.declaredVictory[0]||Kt.declaredVictory[1])return;if(Kt.thrones[r].isAlive)return void(Kt.madeDeclaration=!1);Kt.declaredVictory[s[0]]=!0}else if(i==Ft.DESTROY&&Mt(s[0],s[1],s[2])){var h=Kt.map.entry[s[0]*Kt.map.width+s[1]];h.receiveDamage(1e9)}}function ot(){if(!Kt.isGameOver){var t=(Wt.team+1)%2;if(Kt.commandBackLog[t].length>0&&Kt.commandBackLog[t][0][0]<Kt.timestep){var e=Kt.timestep;_t();var i=0,s=0,a=0,n=0,o=Kt.commandBackLog;Kt.timestep++;for(var i=0,s=0,r=Kt.timestep;e>r;++r){for(;i<o[0].length&&o[0][i][0]==r;)nt(o[0][i],!0),++i;for(;s<o[1].length&&o[1][s][0]==r;)nt(o[1][s],!0),++s;J()}for(var h=0==t?i:s,c=Wt.team,l=0,p=h>0?o[t][h-1][0]:-1;l<o[c].length&&o[c][l][0]<=p;)l++;Kt.commandBackLog[t]=Kt.commandBackLog[t].splice(h),Kt.commandBackLog[c]=Kt.commandBackLog[c].splice(l)}for(var i=0,s=0,a=0,n=0,o=Kt.commandBackLog;i<o[0].length;)o[0][i][0]==Kt.timestep&&(nt(o[0][i]),a=i+1),++i;for(;s<o[1].length;)o[1][s][0]==Kt.timestep&&(nt(o[1][s]),n=s+1),++s;if(o[t].length>0){for(var h=0==t?a:n,c=Wt.team,l=0,p=h>0?o[t][h-1][0]:-1;l<o[c].length&&o[c][l][0]<=p;)l++;Kt.commandBackLog[t]=Kt.commandBackLog[t].splice(h),Kt.commandBackLog[c]=Kt.commandBackLog[c].splice(l)}}}function rt(){Wt.menuBar.render(Wt.g)}function ht(t){return Wt.team==t}function ct(t){jt[Wt.appState].style.setProperty("display","none"),"GAME_FRAME"==Wt.appState&&jt[Wt.appState].style.setProperty("z-index","0"),jt[t].style.setProperty("display","block"),Wt.appState=t,"LOGIN_FRAME"==t?document.getElementById("login-input").focus():"LOBBY_FRAME"==t?(document.getElementById("create-room-form").style.display="none",xt.emit("get-online-player"),xt.emit("get-room-list")):"ROOM_FRAME"==t?It():"GAME_FRAME"==t&&jt[Wt.appState].style.setProperty("z-index","5")}function lt(t){xt.emit("create-room",t)}function pt(t){if(t)document.getElementById("room-list").insertBefore(dt(t),document.getElementById("room-list").lastChild);else{document.getElementById("room-list").innerHTML="";for(var e=0;e<Wt.roomList.length;++e){var i=Wt.roomList[e],s=Wt.room[i];document.getElementById("room-list").appendChild(dt(s))}var a=document.createElement("div");a.setAttribute("class","clear-fix"),document.getElementById("room-list").appendChild(a)}}function dt(t){var e=document.createElement("div"),i="<div class='room-item-title'>["+t.id+"] ";return i+=t.title+"</div>",i+="<div class='room-item-owner'>Owner: ["+t.hostId+"] ",i+=t.hostname+"</div>",i+="<div class='room-item-status'>Status: "+(t.full?'<span class="full">Full</span>':'<span class="avail">Available</span>')+"</div>",e.innerHTML=i,e.onclick=function(){t.full&&Et("Room is currently full."),Wt.enteringRoomId=t.id,xt.emit("join-room",t.id),vt()},e.setAttribute("class","room-item"),t.div=e,e}function ut(t){var e=t.div,i="<div class='room-item-title'>["+t.id+"] ";i+=t.title+"</div>",i+="<div class='room-item-owner'>Owner: ["+t.hostId+"] ",i+=t.hostname+"</div>",i+="<div class='room-item-status'>Status: "+(t.full?'<span class="full">Full</span>':'<span class="avail">Available</span>')+"</div>",e.innerHTML=i}function mt(t){if(t)document.getElementById("online-user-list").appendChild(gt(t));else{document.getElementById("online-user-list").innerHTML="";for(var e=0;e<Wt.online.length;++e){var i=Wt.online[e];document.getElementById("online-user-list").appendChild(gt(Wt.player[i]))}}}function gt(t){var e=document.createElement("div"),i="<div class='id'>"+t.id+"</div>";return i+="<div class='name'>"+t.username+"</div>",e.innerHTML=i,e.setAttribute("class","online-list-item"),t.div=e,e}function ft(t){for(var e=[],i=0;i<Wt.online.length;++i)Wt.online[i]!=t&&e.push(Wt.online[i]);Wt.online=e,Wt.playingWithId==t&&yt(),delete Wt.player[t]}function yt(){Kt.declaredVictory[Wt.team]=!0,Rt()}function Et(t){}function vt(){document.getElementById("waiting-screen").style.display="block"}function At(){document.getElementById("waiting-screen").style.display="none"}function It(){document.getElementById("room-frame-title").innerHTML="Room Title : ["+Wt.currentRoom.id+"] "+Wt.currentRoom.title,document.getElementById("start-game-button").style.display=Wt.isHost?"block":"none",document.getElementById("map-options").style.display=Wt.isHost?"block":"none",Wt.currentRoom.isSinglePlayer?(document.getElementById("room-frame-guest").innerHTML="Simple Piggi AI",document.getElementById("guest-title").style.setProperty("background-color","rgba(133,255,133,0.5)"),document.getElementById("start-game-button").style.setProperty("opacity","1.0")):(document.getElementById("room-frame-guest").innerHTML=-1==Wt.currentRoom.guestId?"Waiting.":"["+Wt.currentRoom.guestId+"] "+Wt.player[Wt.currentRoom.guestId].username,
-1==Wt.currentRoom.guestId?(document.getElementById("guest-title").style.setProperty("background-color","rgba(255,100,100,0.5)"),document.getElementById("start-game-button").style.setProperty("opacity","0.5")):(document.getElementById("guest-title").style.setProperty("background-color","rgba(133,255,133,0.5)"),document.getElementById("start-game-button").style.setProperty("opacity","1.0"))),document.getElementById("room-frame-host").innerHTML="["+Wt.currentRoom.hostId+"] "+Wt.player[Wt.currentRoom.hostId].username;var t=document.getElementById("map-info-canvas"),e=t.getContext("2d"),i=Vt[Wt.currentRoom.chosenMap];e.drawImage(zt.images[i.asset],0,0,zt.images[i.asset].width,zt.images[i.asset].width,0,0,t.width,t.height),document.getElementById("map-title").innerHTML="Location : "+i.title,document.getElementById("map-dimension").innerHTML="Size : "+i.width+" x "+i.height}function Tt(t){Wt.isSinglePlayer||!t&&Kt.timestep-Kt.lastSent<=Yt.SEND_DELAY||(Kt.lastSent=Kt.timestep,Kt.localCommandLog.push([Kt.timestep-1,Ft.SYNCHRONIZED,[]]),xt.emit("commands",Kt.localCommandLog),Kt.localCommandLog=[])}function Lt(){for(var t={map:{data:new Int32Array(Kt.map.width*Kt.map.height).fill(1),entry:new Array(Kt.map.width*Kt.map.height).fill(null),lastUpdated:0},deadflocks:[],deadarrows:[],deadbuildings:[],flocks:[],buildings:[],arrows:[],timestep:0,thrones:[],ranchTier:[1,1],towerTier:[1,1],coins:[10,10],declaredVictory:[!1,!1],madeDeclaration:!1},e=0;e<Kt.map.width*Kt.map.height;++e)t.map.data[e]=Kt.map.data[e];for(var e=0;e<Kt.map.width*Kt.map.height;++e)t.map.entry[e]=Kt.map.entry[e];t.map.lastUpdated=Kt.map.lastUpdated;for(var e=0;e<Kt.deadflocks.length;++e)t.deadflocks.push(Kt.deadflocks[e]),Kt.deadflocks[e].createSnapshot();for(var e=0;e<Kt.deadbuildings.length;++e)t.deadbuildings.push(Kt.deadbuildings[e]),Kt.deadbuildings[e].createSnapshot();for(var e=0;e<Kt.deadarrows.length;++e)t.deadarrows.push(Kt.deadarrows[e]),Kt.deadarrows[e].createSnapshot();t.timestep=Kt.timestep;for(var e=0;e<Kt.flocks.length;++e)t.flocks.push(Kt.flocks[e]),Kt.flocks[e].createSnapshot();for(var e=0;e<Kt.buildings.length;++e)t.buildings.push(Kt.buildings[e]),Kt.buildings[e].createSnapshot();for(var e=0;e<Kt.arrows.length;++e)t.arrows.push(Kt.arrows[e]),Kt.arrows[e].createSnapshot();for(var e=0;e<Kt.thrones.length;++e)t.thrones.push(Kt.thrones[e]),Kt.thrones[e].createSnapshot();for(var e=0;e<Kt.ranchTier.length;++e)t.ranchTier[e]=Kt.ranchTier[e],t.towerTier[e]=Kt.towerTier[e],t.coins[e]=Kt.coins[e],t.declaredVictory[e]=Kt.declaredVictory[e];t.madeDeclaration=Kt.madeDeclaration,Kt.snapshot=t}function _t(){snapshot=Kt.snapshot;for(var t=0;t<Kt.map.width*Kt.map.height;++t)Kt.map.data[t]=snapshot.map.data[t];for(var t=0;t<Kt.map.width*Kt.map.height;++t)Kt.map.entry[t]=snapshot.map.entry[t];Kt.map.lastUpdated=snapshot.map.lastUpdated,Kt.deadflocks=snapshot.deadflocks;for(var t=0;t<Kt.deadflocks.length;++t)Kt.deadflocks[t].rollback();Kt.flocks=snapshot.flocks;for(var t=0;t<Kt.flocks.length;++t)Kt.flocks[t].rollback();Kt.deadbuildings=snapshot.deadbuildings;for(var t=0;t<Kt.deadbuildings.length;++t)Kt.deadbuildings[t].rollback();Kt.buildings=snapshot.buildings;for(var t=0;t<Kt.buildings.length;++t)Kt.buildings[t].rollback();Kt.deadarrows=snapshot.deadarrows;for(var t=0;t<Kt.deadarrows.length;++t)Kt.deadarrows[t].rollback();Kt.arrows=snapshot.arrows;for(var t=0;t<Kt.arrows.length;++t)Kt.arrows[t].rollback();Kt.timestep=snapshot.timestep,Kt.thrones=snapshot.thrones;for(var t=0;t<Kt.thrones.length;++t)Kt.thrones[t].rollback();for(var t=0;t<Kt.ranchTier.length;++t)Kt.ranchTier[t]=snapshot.ranchTier[t],Kt.towerTier[t]=snapshot.towerTier[t],Kt.coins[t]=snapshot.coins[t],Kt.declaredVictory[t]=snapshot.declaredVictory[t];Kt.madeDeclaration=snapshot.madeDeclaration}function wt(t){var e=(Wt.team+1)%2;Kt.commandBackLog[e]=Kt.commandBackLog[e].concat(t)}function kt(){jt.GAME_FRAME.style.setProperty("display","block"),j(0),Kt.flocks.push(new d(new t(canvas.width/2,canvas.height/2),0));var e=-1e4,i=1e3;Kt.thrones[1].isAlive=!1,Kt.scheduler=setInterval(function(){Kt.timestep-e>i&&(Kt.flocks[0].setLockOnTarget({isAlive:!0,MOVING_TARGET:!0,pos:new t(Math.random()*Kt.map.width*Kt.map.size,Math.random()*Kt.map.height*Kt.map.size)},Kt.map),e=Kt.timestep),J(),Wt.camera[0]=Kt.flocks[0].pos.x-Wt.canvas.width/2,Wt.camera[1]=Kt.flocks[0].pos.y-Wt.canvas.height/2,X(),q()},Yt.FPS)}function Rt(){Wt.isGameOngoing&&(Kt.isGameOver=!0,Wt.isGameOngoing=!1,Tt(!0),Ot())}function Ct(){Wt.state="NONE",Wt.isSinglePlayer=!1,Kt.scheduler&&clearInterval(Kt.scheduler),Kt.gameEventHandlerResetFunction&&Kt.gameEventHandlerResetFunction(),St()}function Ot(){function t(){document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock,document.exitPointerLock(),Ct(),document.removeEventListener("click",t),document.removeEventListener("keydown",e),document.getElementById("game-over-notice").style.display="none",ct("ROOM_FRAME"),kt()}function e(){document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock,document.exitPointerLock(),Ct(),document.removeEventListener("click",t),document.removeEventListener("keydown",e),document.getElementById("game-over-notice").style.display="none",ct("ROOM_FRAME"),kt()}Kt.declaredVictory[Wt.team]?document.getElementById("notice-text1").innerHTML="You Win!":document.getElementById("notice-text1").innerHTML="You Lose.",Wt.mouseTrapped?document.getElementById("notice-text2").innerHTML="Press any key to exit.":document.getElementById("notice-text2").innerHTML="Click here to exit.",document.addEventListener("click",t),document.addEventListener("keydown",e),document.getElementById("game-over-notice").style.display="block"}function Dt(t){document.getElementById("game-notice-box").innerHTML=t,document.getElementById("game-notice-box").style.display="block"}function St(){document.getElementById("game-notice-box").style.display="none"}function Mt(t,e,i){var s=Kt.map.entry[t*Kt.map.width+e];return s&&s.team==i&&s.destroyable}function Bt(){Vt.push({title:"Pigidow",asset:"asset/pigidow.jpg",width:20,height:32,thrones:[[0,0],[30,18]],specialEffect:null}),Vt.push({title:"Snowy Yosemite",asset:"asset/snowy-yosemite.jpg",width:25,height:40,thrones:[[0,12],[38,13]],specialEffect:bt}),Vt.push({title:"Furpig Valley",asset:"asset/furpig-valley.jpg",width:4,height:20,thrones:[[0,1],[18,1]],specialEffect:null})}function bt(){var e=[],i=300;return function(s){if(Math.random()<.4){var a=Math.random()*Kt.map.width*Kt.map.size,n=Math.random()*Kt.map.height*Kt.map.size;e.push({pos:new t(a,n),delta:0})}for(var o=[],r=0;r<e.length;++r)if(!(e[r].delta>=i)){if(o.push(e[r]),e[r].delta%20==0){var h=(Math.random()<.5?-1:1)*Math.random(),c=Math.random(),l=new t(h,c).normalize().times(.8);e[r].v=l}e[r].pos=e[r].pos.plus(e[r].v),s.drawImage(zt.images["asset/snow.png"],0,0,128,128,e[r].pos.x,e[r].pos.y,32,32),e[r].delta++}e=o}}function Pt(){document.getElementById("tutorial-div").style.display="block"}function Nt(){document.getElementById("tutorial-div").style.display="none"}function Ut(){ct("GAME_FRAME"),Kt.scheduler&&clearInterval(Kt.scheduler),Kt.gameEventHandlerResetFunction&&Kt.gameEventHandlerResetFunction(),Kt={},jt.GAME_FRAME.style.setProperty("display","block"),Wt.isGameOngoing=!0,Wt.isSinglePlayer=!0,j(Wt.currentRoom.chosenMap),Wt.menuBar=new C,Wt.team=0,Wt.camera[0]=Kt.thrones[Wt.team].pos.x-Wt.canvas.width/2,Wt.camera[1]=Kt.thrones[Wt.team].pos.y-Wt.canvas.height/2,Wt.gameEventHandlerResetFunction=et(),Lt(),Kt.snapshot.timestep=-1,Kt.AI={},Kt.AI.farms=0,Kt.AI.fences=0,Kt.AI.ranches=0,Kt.AI.towers=0,Kt.scheduler=setInterval(function(){Kt.isGameOver||(Gt(),ot(),J()),X(),q(),rt(),Z(),Kt.isGameOver||Tt()},Yt.FPS)}function Gt(){var t=(Kt.thrones[1].row,!1);if(!(Kt.timestep%30))for(var e=Kt.map.height;e>=0;--e){for(var i=0;i<Kt.map.width;i++){if(!it(e-1,i,2)){if(t=!0,Math.random()<.9)if(Math.random()<.9){if(Kt.coins[1]>Ht.BUILD_PIG_RANCH){Kt.AI.ranches++,Kt.coins[1]-=Ht.BUILD_PIG_RANCH,at(Ft.BUILD_PIG_RANCH,[e-1,i,1]);break}}else if(Kt.coins[1]>Ht.BUILD_TOWER){Kt.AI.towers++,Kt.coins[1]-=Ht.BUILD_TOWER,at(Ft.BUILD_TOWER,[e-1,i,1]);break}if((Kt.AI.farms+Kt.AI.fences)/(Kt.AI.ranches+Kt.AI.towers+1)>10)break}if(!it(e,i,1)&&(t=!0,Math.random()<.8))if(Math.random()<.7){if(Kt.AI.farms<200&&Kt.coins[1]>Ht.BUILD_FARM){Kt.AI.farms++,Kt.coins[1]-=Ht.BUILD_FARM,at(Ft.BUILD_FARM,[e,i,1]);break}}else if(Math.random()<.001&&Kt.coins[1]>Ht.BUILD_FENCE){Kt.AI.fences++,Kt.coins[1]-=Ht.BUILD_FENCE,at(Ft.BUILD_FENCE,[e,i,1]);break}if(t)break}if(t)break}}t.prototype.minus=function(e){return new t(this.x-e.x,this.y-e.y)},t.prototype.normalize=function(){var t=this.length();return 0==t?this:(this.x/=t,this.y/=t,this)},t.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},t.prototype.rotate=function(t){t=Math.PI/180*t;var e=this.x,i=this.y,s=Math.cos(t),a=Math.sin(t);return this.x=e*s-i*a,this.y=e*a+i*s,this},t.prototype.dot=function(t){return this.x*t.x+this.y*t.y},t.prototype.copy=function(){return new t(this.x,this.y)},t.prototype.flip=function(){return new t(-this.x,-this.y)},t.prototype.plus=function(e){return new t(this.x+e.x,this.y+e.y)},t.prototype.times=function(e){return new t(this.x*e,this.y*e)},t.prototype.cross=function(t){return this.x*t.y-this.y*t.x},t.prototype.resize=function(t){var e=this.length();return this.x*=t/e,this.y*=t/e,this},s.prototype.push=function(t){if(null==this.root)this.root=new a(t);else{var e=Math.floor((this.size+1)/2),i=new a(t),s=this.atIndex(e);2*e==this.size+1?s.setLeft(i):s.setRight(i),this.heapUp(i)}this.size++},s.prototype.top=function(){return 0==this.size?null:this.root.value},s.prototype.pop=function(){var t=this.atIndex(this.size);this.size>1?(this.root.value=t.value,t.parent.left==t?t.parent.left=null:t.parent.right=null,t.parent=null,this.heapDown(this.root)):this.root=null,this.size--},s.prototype.atIndex=function(t){if(t>this.size)return null;for(var e=[],i=t;i>1;){var s=Math.floor(i/2);2*s==i?e.push("L"):e.push("R"),i=Math.floor(i/2)}for(var a=this.root,n=e.length-1;n>=0;--n)a="L"==e[n]?a.left:a.right;return a},s.prototype.heapUp=function(t){for(;t.parent&&!this.lessThan(t.parent.value,t.value);){var e=t.value;t.value=t.parent.value,t.parent.value=e,t=t.parent}},s.prototype.heapDown=function(t){for(;;){var e=null;if(t.left&&!this.lessThan(t.value,t.left.value)&&(e=t.left),t.right&&!this.lessThan(t.value,t.right.value)&&(!e||this.lessThan(t.right.value,e.value))&&(e=t.right),!e)return;var i=e.value;e.value=t.value,t.value=i,t=e}},a.prototype.setLeft=function(t){this.left=t,t.parent=this},a.prototype.setRight=function(t){this.right=t,t.parent=this},n.prototype.push=function(t){this.stackIn.push(t)},n.prototype.pop=function(){if(this.stackOut.length+this.stackIn.length==0)return null;if(0==this.stackOut.length)for(;this.stackIn.length>0;)this.stackOut.push(this.stackIn.pop());return this.stackOut.pop()},n.prototype.empty=function(){return this.stackIn.length+this.stackOut.length==0};h.prototype.render=function(t,e,i){var s=this.offsetX+this.currentFrame*this.width;t.drawImage(this.imgBuffer,s,this.offsetY,this.width,this.height,0,0,e,i)},h.prototype.update=function(){this.delta>=this.DELTA_PER_FRAME&&(this.delta=0,this.currentFrame++,this.autoReset?this.currentFrame%=this.numOfFrames:this.currentFrame=Math.min(this.currentFrame,this.numOfFrames-1)),this.delta++},h.prototype.reset=function(){this.delta=0,this.currentFrame=0},h.prototype.createSnapshot=function(){this.snapshot={delta:this.delta,currentFrame:this.currentFrame}},h.prototype.rollback=function(){this.delta=this.snapshot.delta,this.currentFrame=this.snapshot.currentFrame},c.prototype.seek=function(){var t=this.steeringEffect;if(null!=this.target){var e=i(this.target.minus(this.pos),this.MAXIMUM_SPEED),s=e.minus(this.velocity).times(t);this.force=this.force.plus(s)}},c.prototype.integrate=function(t){var s=this.force.times(this.invMass);s=i(s,this.AVOIDANCE_SPEED),this.velocity=this.velocity.plus(s),this.velocity=i(this.velocity,this.MAXIMUM_SPEED),this.pos=this.pos.plus(this.velocity);var a=this.steeringForce.times(this.invMass);a=i(a,this.AVOIDANCE_SPEED),this.pos=this.pos.plus(a),this.pos.x=Math.max(0,Math.min(this.pos.x,t.width*t.size-this.radius)),this.pos.y=Math.max(0,Math.min(this.pos.y,t.height*t.size-this.radius)),null!=this.target&&(this.orientation=e(this.velocity)),null==this.target&&0==this.targetStack.length&&null==this.lockOnTarget?this.velocity=this.velocity.times(.95):this.target&&this.target.minus(this.pos).length()<this.TARGET_RADIUS&&(this.target=this.targetStack.pop()),this.lockOnTarget&&this.lockOnTarget.pos.minus(this.pos).length()<.8*this.TARGET_RADIUS&&0==this.targetStack.length&&(this.velocity=this.velocity.times(.5)),this.force.x=this.force.y=0,this.steeringForce.x=this.steeringForce.y=0},c.prototype.setPath=function(t){this.targetStack=t,this.target=t.pop()},c.prototype.getInteractionType=function(t){t.setState(t.ATTACKING)},c.prototype.update=function(e,i){if(this.updateCount++,this.isAlive){var s=0!=this.integrateOnlyCounter;this.integrateOnlyCounter--,0==this.integrateOnlyCounter&&(this.integrateOnlyCounter=this.INTEGRATE_ONLY_MAX_COUNTER);var a=1,n=.04,o=1,r=60,h=1/30;this.checkSurrounding(e,i),this.seek();var c=this.pos.plus(this.velocity.times(h));if(!s){for(var l=0;l<e.length;++l)if(this!=e[l]){var p=this.pos.minus(e[l].pos);if(p.length()<r){var d=c.minus(e[l].pos).normalize();0==d.length()&&(d=new t(1,l),d.normalize());var u=d.times(this.AVOIDANCE_SPEED*a);this.steeringForce=this.steeringForce.plus(u)}}for(var m=-1,g=1e9,l=0;l<e.length;++l)if(this!=e[l]){var f=e[l].pos.plus(e[l].velocity.times(h)),y=c.minus(f).length();g>y&&(m=l,g=y)}if(-1!=m&&g<=e[m].radius){var E=c.minus(e[m].pos.plus(e[m].velocity.times(h)));E=E.normalize().times(this.AVOIDANCE_SPEED*o),this.force=this.force.plus(E)}}if(i){m=-1,g=1e9;var v=[Math.floor(c.y/i.size),Math.floor(c.x/i.size)],A=v[0]*i.width+v[1];if(A>0&&A<i.data.length&&0==i.data[A]){var E=c.minus(new t(i.size*(v[1]+.5),i.size*(v[0]+.5)));E=E.normalize().times(this.AVOIDANCE_SPEED),this.force=this.force.plus(E)}}if(this.integrate(i),s){for(var I=0,T=0,l=0;l<e.length;++l){var p=this.pos.minus(e[l].pos);p.length()<r&&(I+=e[l].orientation,T++)}T>0&&(I/=T,this.orientation=(1-n)*this.orientation+n*I)}if(i)for(var v=[Math.floor(this.pos.y/i.size),Math.floor(this.pos.x/i.size)],L=-1;1>=L;++L)for(var _=-1;1>=_;++_)this.resolveCollisionWithMap(i,[v[0]+L,v[1]+_]);this.handleLockOnTarget(e,i)}},c.prototype.checkSurrounding=function(e,i){function s(t,e){var i=e[0]*t.width+e[1];return i}function a(t,e){if(!(0>t||0>e||t>=i.height||e>=i.width)){var a=s(i,[t,e]);1!=d[a]&&(d[a]=1,p.push([t,e]))}}if(!(this.updateCount-this.lastEnvironmentCheck<=this.ENVIRONMENT_CHECK_DELAY)){this.lastEnvironmentCheck=this.updateCount,this.lockOnTarget&&this.setLockOnTarget(this.lockOnTarget,i);for(var o=1e9,r=-1,h=0;h<e.length;++h)if(e[h].isAlive&&e[h].team!=this.team){var c=e[h].pos.minus(this.pos).length();if(c>this.FLOCK_AGGRESIVENESS)continue;o>c&&(o=c,r=h)}if(-1!=r){var l=this.setLockOnTarget(e[r],i);if(l)return}var p=new n,d=new Int32Array(i.width*i.height).fill(0),u=[Math.floor(this.pos.y/i.size),Math.floor(this.pos.x/i.size)];for(p.push(u),d[s(i,u)]=1;!p.empty();){var m=p.pop(),g=s(i,m),f=new t((m[1]+.5)*i.size,(m[0]+.5)*i.size);if(!(this.pos.minus(f).length()>=this.BUILDING_AGGRESIVENESS)){if(i.entry[g]){var y=i.entry[g];if(y.canInteract(this)){var l=this.setLockOnTarget(y,i);if(l)break}}a(m[0]-1,m[1]),a(m[0]+1,m[1]),a(m[0],m[1]+1),a(m[0],m[1]-1)}}}},c.prototype.handleLockOnTarget=function(t,i){if(this.lockOnTarget){if(!this.lockOnTarget.isAlive)return this.lockOnTarget=null,this.state=this.STANDBY,this.target=null,this.targetStack=[],void(this.provoked=!1);var s=this.lockOnTarget.pos.minus(this.pos).length();s<=this.radius+this.lockOnTarget.radius+this.attackRadius?(this.targetStack=[],this.target=this.lockOnTarget.pos,this.lockOnTarget.MOVING_TARGET&&(this.target=null),this.lockOnTarget.getInteractionType(this),this.state==this.ATTACKING&&(this.updateCount-this.lastAttack>this.ATTACK_DELAY?(this.lastAttack=this.updateCount+this.sprites[this.ATTACKING].DELTA_PER_FRAME*this.sprites[this.ATTACKING].numOfFrames,this.sprites[this.ATTACKING].reset()):this.updateCount-this.lastAttack==-2*this.sprites[this.ATTACKING].DELTA_PER_FRAME&&(this.lockOnTarget.receiveDamage(this.strength),this.velocity=this.velocity.times(0))),this.state==this.EATING&&this.updateCount-this.lastAttack>this.ATTACK_DELAY&&(this.lockOnTarget.receiveDamage(this.strength),this.lastAttack=this.updateCount,this.velocity=this.velocity.times(0))):this.target||(s<2*i.size?this.target=this.lockOnTarget.pos:this.setLockOnTarget(this.lockOnTarget,i,!0)),(this.state==this.ATTACKING||this.state==this.EATING)&&(this.orientation=e(this.lockOnTarget.pos.minus(this.pos).normalize()))}},c.prototype.setLockOnTarget=function(t,e,i){if(!t.isAlive)return!1;if(t==this.lockOnTarget&&!i&&e.lastUpdated==this.pathTimestamp)return!0;if(null!=this.lockOnTarget&&this.lockOnTarget.interactionCount--,this.provoked=!0,this.lockOnTarget=t,t.interactionCount++,t.pos.minus(this.pos)<=e.size)return this.targetStack=[],this.target=t.pos,!0;var s=[Math.floor(this.pos.y/e.size),Math.floor(this.pos.x/e.size)],a=Math.floor(t.pos.y/e.size),n=Math.floor(t.pos.x/e.size),h=[];if(!t.MOVING_TARGET){var c=Math.floor(t.size/e.size);if(a=t.row+Math.floor(c/2),n=t.col+Math.floor(c/2),t.row-1>=0)for(var l=0;c>l;++l)h.push([t.row-1,t.col+l]);if(t.col-1>=0)for(var l=0;c>l;++l)h.push([t.row+l,t.col-1]);if(t.row+c<e.height)for(var l=0;c>l;++l)h.push([t.row+c,t.col+l]);if(t.col+c<e.width)for(var l=0;c>l;++l)h.push([t.row+l,t.col+c])}var p=o(s,[a,n],e,h),d=r(p,e);d[d.length-1]=this.pos,this.setPath(d);var u=p.length>0&&Math.abs(a-p[0][0])+Math.abs(n-p[0][1])<=1;if(!t.MOVING_TARGET&&p.length)for(var c=Math.floor(t.size/e.size),l=0;l<h.length;++l)if(Math.abs(h[l][0]-p[0][0])+Math.abs(h[l][1]-p[0][1])<=1){u=!0;break}return this.pathTimestamp=e.lastUpdated,u},c.prototype.setState=function(t){this.state=t},c.prototype.receiveDamage=function(t){this.isAlive&&(this.provoked=!0,this.healthPoints-=t,this.healthPoints<=0&&(this.healthPoints=0,this.isAlive=!1,this.state=this.DEAD,this.timeOfDeath=this.updateCount,this.lockOnTarget&&(this.lockOnTarget.interactionCount--,this.lockOnTarget=null)))},c.prototype.cleanUp=function(t,e){},c.prototype.garbageCollectible=function(){return!this.isAlive&&this.updateCount-this.timeOfDeath>=this.PERSISTENCE},c.prototype.resolveCollisionWithMap=function(e,i){var s=.1;if(this.collidesWithCell(e,i)){var a=i[0]*e.width+i[1];if(a>0&&a<e.data.length&&0==e.data[a]){var n=this.pos.minus(new t((i[1]+.5)*e.size,(i[0]+.5)*e.size)),o=e.size-Math.abs(n.x),r=new t(Math.sign(n.x),0);Math.abs(n.y)>Math.abs(n.x)&&(o=e.size-Math.abs(n.y),r.x=0,r.y=Math.sign(n.y)),this.pos=this.pos.plus(r.times(o*s))}}},c.prototype.collidesWithCell=function(t,e){return!(e[0]<0||e[1]<0||e[0]>=t.height||e[1]>=t.width||e[1]*t.size>this.pos.x+this.radius||(e[1]+1)*t.size<this.pos.x-this.radius||e[0]*t.size>this.pos.y+this.radius||(e[0]+1)*t.size<this.pos.y-this.radius)},c.prototype.drawTest=function(t){t.save(),t.rotate(Math.PI/2),t.scale(1,-1),t.fillStyle="black",t.beginPath(),t.moveTo(0,this.radius),t.lineTo(this.radius/2,-this.radius/2*Math.sqrt(3)),t.lineTo(-this.radius/2,-this.radius/2*Math.sqrt(3)),t.closePath(),t.fill(),t.restore()},l.prototype=Object.create(c.prototype),l.prototype.setSprite=function(t,e){this.sprites[t]=e},l.prototype.update=function(t,e){c.prototype.update.call(this,t,e),this.sprites[this.state].update()},l.prototype.render=function(t){if(t.save(),!this.isAlive){var e=1-Math.max(0,(this.updateCount-this.timeOfDeath)/this.PERSISTENCE);e=.5>e?.5:1,t.globalAlpha=e}t.translate(Math.floor(this.pos.x),Math.floor(this.pos.y)),t.rotate(Math.floor((this.orientation+90)/180*Math.PI*10)/10),t.translate(-this.radius,-this.radius),this.sprites[this.state].render(t,2*this.radius,2*this.radius),t.restore()},l.prototype.integrate=function(t){c.prototype.integrate.call(this,t),null==this.target&&this.state!=this.ATTACKING&&this.state!=this.EATING&&(this.state=this.STANDBY)},l.prototype.setPath=function(t){c.prototype.setPath.call(this,t),this.state==this.STANDBY?this.state=this.MOVING:null!=this.targetStack[0]&&this.pos.minus(this.targetStack[0]).length()>=4*this.radius&&(this.state=this.MOVING)},l.prototype.createSnapshot=function(){this.snapshot={pos:this.pos.copy(),force:this.force.copy(),steeringForce:this.steeringForce.copy(),velocity:this.velocity.copy(),orientation:this.orientation,target:this.target,targetStack:this.targetStack.slice(),pathTimestamp:this.pathTimestamp,state:this.state,lastEnvironmentCheck:this.lastEnvironmentCheck,updateCount:this.updateCount,lockOnTarget:this.lockOnTarget,lastAttack:this.lastAttack,healthPoints:this.healthPoints,isAlive:this.isAlive,provoked:this.provoked,timeOfDeath:this.timeOfDeath,integrateOnlyCounter:this.integrateOnlyCounter},this.sprites[this.state].createSnapshot()},l.prototype.rollback=function(){this.pos=this.snapshot.pos.copy(),this.force=this.snapshot.force.copy(),this.steeringForce=this.snapshot.steeringForce.copy(),this.velocity=this.snapshot.velocity.copy(),this.orientation=this.snapshot.orientation,this.target=this.snapshot.target,this.targetStack=this.snapshot.targetStack,this.pathTimestamp=this.snapshot.pathTimestamp,this.state=this.snapshot.state,this.lastEnvironmentCheck=this.snapshot.lastEnvironmentCheck,this.updateCount=this.snapshot.updateCount,this.lockOnTarget=this.snapshot.lockOnTarget,this.lastAttack=this.snapshot.lastAttack,this.healthPoints=this.snapshot.healthPoints,this.isAlive=this.snapshot.isAlive,this.provoked=this.snapshot.provoked,this.timeOfDeath=this.snapshot.timeOfDeath,this.integrateOnlyCounter=this.snapshot.integrateOnlyCounter,this.sprites[this.state].rollback()},p.prototype.setSprite=function(t,e){this.sprites[t]=e},p.prototype.render=function(t){if(this.sprites[this.state]){if(t.save(),t.translate(this.pos.x-this.size/2,this.pos.y-this.size/2),t.save(),!this.isAlive){var e=1-Math.max(0,(this.updateCount-this.timeOfDeath)/this.PERSISTENCE);e=.5>e?.5:1,t.globalAlpha=e}this.sprites[this.state].render(t,this.size,this.size),t.restore(),t.fillStyle="rgba(0,0,0,0.5)",this.SHOW_HEALTHBAR&&(t.fillRect(2,0,this.size-4,8),t.fillStyle="rgba(255,255,0,0.9)",t.fillRect(3,1,(this.size-6)*this.healthPoints/this.maxHealthPoints,6)),t.restore()}},p.prototype.canInteract=function(t){return this.team!=t.team?this.interactionType==this.NO_INTERACTION?!1:this.activity!=this.PASSIVE||t.provoked?this.interactionCount>=this.MAX_INTERACTION||t.pos.minus(this.pos).length()>=this.interactionDistance?!1:!0:!1:void 0},p.prototype.getInteractionType=function(t){this.interactionType==this.ATTACK_TYPE?t.setState(t.ATTACKING):this.interactionType==this.EAT_TYPE&&t.setState(t.EATING)},p.prototype.receiveDamage=function(t){c.prototype.receiveDamage.call(this,t)},p.prototype.update=function(t,e){this.updateCount++,this.sprites[this.state].update()},p.prototype.cleanUp=function(t,e){k(this,e)},p.prototype.garbageCollectible=function(){return c.prototype.garbageCollectible.call(this)},p.prototype.createSnapshot=function(){this.snapshot={state:this.state,lastAttack:this.lastAttack,healthPoints:this.healthPoints,isAlive:this.isAlive,updateCount:this.updateCount,interactionCount:this.interactionCount,timeOfDeath:this.timeOfDeath},this.sprites[this.state].createSnapshot()},p.prototype.rollback=function(){this.state=this.snapshot.state,this.lastAttack=this.snapshot.lastAttack,this.healthPoints=this.snapshot.healthPoints,this.isAlive=this.snapshot.isAlive,this.updateCount=this.snapshot.updateCount,this.timeOfDeath=this.snapshot.timeOfDeath,this.interactionCount=this.snapshot.interactionCount,this.sprites[this.state].rollback()},d.prototype=Object.create(l.prototype),d.prototype.update=function(t,e){if(l.prototype.update.call(this,t,e),this.isAlive&&null==this.lockOnTarget){var i=this.team+1;i%=2,this.setLockOnTarget(Kt.thrones[i],e)}},u.prototype=Object.create(d.prototype),m.prototype=Object.create(p.prototype),m.prototype.update=function(t,e){if(p.prototype.update.call(this,t,e),this.isAlive&&!(this.updateCount-this.lastAttack<=this.ATTACK_DELAY)){this.lastAttack=this.updateCount;for(var i=0;i<t.length;++i)if(t[i].isAlive&&t[i].team!=this.team&&t[i].pos.minus(this.pos).length()<=this.attackRadius)return void Kt.arrows.push(new this.weapon(this,t[i],this.strength))}},g.prototype=Object.create(m.prototype),f.prototype=Object.create(p.prototype),f.prototype.createSnapshot=function(){A.prototype.createSnapshot.call(this)},f.prototype.rollback=function(){A.prototype.rollback.call(this)},f.prototype.update=function(t,e){p.prototype.update.call(this,t,e),this.updateCount-this.lastProduce<=this.PRODUCE_DELAY||(this.lastProduce=this.updateCount,Kt.coins[this.team]+=this.coinsToHarvest)},y.prototype=Object.create(f.prototype),E.prototype=Object.create(p.prototype),E.prototype.canInteract=function(t){return p.prototype.canInteract.call(this,t)&&null!=t.lockOnTarget&&0==t.targetStack.length},v.prototype=Object.create(E.prototype),A.prototype=Object.create(p.prototype),A.prototype.update=function(e,i){if(p.prototype.update.call(this,e,i),this.isAlive&&!(this.updateCount-this.lastProduce<=this.PRODUCE_DELAY||Kt.coins[this.team]<this.productPrice)){Kt.coins[this.team]-=this.productPrice,this.lastProduce=this.updateCount;for(var s=[[2,0],[2,1],[-1,0],[-1,1],[0,-1],[1,-1],[0,2],[1,2]],a=0;a<s.length;++a){var n=s[a][0]+this.row,o=s[a][1]+this.col;if(!(0>n||0>o||n>=Kt.map.height||o>=Kt.map.width)&&1==Kt.map.data[n*Kt.map.width+o]){for(var r=0;r<this.pigsPerProduction;++r)Kt.flocks.push(new this.product(new t((o+.5)*Kt.map.size,(n+.5)*Kt.map.size),this.team));return}}}},A.prototype.createSnapshot=function(){p.prototype.createSnapshot.call(this),this.snapshot.lastProduce=this.lastProduce},A.prototype.rollback=function(){p.prototype.rollback.call(this),this.lastProduce=this.snapshot.lastProduce},I.prototype=Object.create(A.prototype),T.prototype=Object.create(p.prototype),L.prototype=Object.create(l.prototype),L.prototype.update=function(){if(this.updateCount++,this.isAlive){var t=17;this.pos=this.destination.minus(this.startPoint).times(Math.min(this.updateCount,this.maxDelta-t)/(this.maxDelta-t)).plus(this.startPoint),this.updateCount+t>=this.maxDelta&&(this.state=this.DEAD,this.target.receiveDamage(this.damage),this.damage=0),this.updateCount>=this.maxDelta&&(this.isAlive=!1,this.timeOfDeath=this.updateCount)}},L.prototype.createSnapshot=function(){l.prototype.createSnapshot.call(this),this.snapshot.updateCount=this.updateCount},L.prototype.rollback=function(){l.prototype.rollback.call(this),this.updateCount=this.snapshot.updateCount},_.prototype=Object.create(L.prototype),C.prototype.updatePosition=function(){var t=Wt.canvas.width,e=Wt.canvas.height;this.x=t/2,this.y=e-this.height/2},C.prototype.render=function(t){t.save(),this.updatePosition(),t.translate(this.x-this.width/2,this.y-this.height/2),t.fillStyle="rgba(0,0,0,0.2)",t.fillRect(0,0,this.width,this.height);for(var e=0;e<this.icons.length;++e)this.icons[e].update(),this.icons[e].render(t);var i=40,s=i+.5*i*4+4+4,a=i+4;t.translate(-s,this.height-a),t.fillRect(0,0,s,a),t.drawImage(zt.images["asset/pig_coin.png"],0,0,128,128,2,2,i,i),t.translate(i+4,0),t.fillStyle="rgba(255,245,200,0.5)",t.fillRect(1,3,s-i-4-2,a-6),t.translate(4,4);var n=F(Kt.coins[Wt.team],32);t.translate(s-i-8-n.width-.5*i/2,0),n.render(t),t.restore()},C.prototype.containsPoint=function(t,e){return this.x-this.width/2<=t&&t<=this.x+this.width/2&&this.y-this.height/2<=e&&e<=this.y+this.height/2},C.prototype.onclick=function(t,e){for(var i=t-(this.x-this.width/2),s=e-(this.y-this.height/2),a=0;a<this.icons.length;++a)if(this.icons[a].containsPoint(i,s))return void this.icons[a].onclick()},C.prototype.reset=function(){for(var t=0;t<this.icons.length;++t)this.icons[t].state="INACTIVE";this.deselect.toCancel=!1},O.prototype.render=function(t){t.save(),"INACTIVE"==this.state?t.fillStyle="rgba(255,255,255,0.5)":"ACTIVE"==this.state&&(t.fillStyle="rgba(255,255,100,0.8)"),t.translate(this.x-this.width/2,this.y-this.height/2),t.fillRect(0,0,this.width,this.height),this.sprite.render(t,this.width,this.height),this.isLocked&&t.drawImage(zt.images["asset/locked_icon.png"],0,0,128,128,0,0,this.width,this.height),("UNCLICKABLE"==this.state||"LOCKED"==this.state)&&(t.fillStyle="rgba(0,0,0,0.5)",t.fillRect(0,0,this.width,this.height)),t.restore()},O.prototype.update=function(){},O.prototype.containsPoint=function(t,e){return C.prototype.containsPoint.call(this,t,e)},O.prototype.onclick=function(){if("UNCLICKABLE"!=this.state&&"LOCKED"!=this.state){for(var t=0;t<Wt.menuBar.icons.length;++t)Wt.menuBar.icons[t].state="LOCKED";Wt.menuBar.deselect.state="INACTIVE",Wt.menuBar.deselect.toCancel=!0,this.state="ACTIVE"}},D.prototype=Object.create(O.prototype),D.prototype.update=function(){"LOCKED"!=this.state&&"ACTIVE"!=this.state&&this.isAlive&&(Ht[this.commandType]<=Kt.coins[Wt.team]?this.state="INACTIVE":this.state="UNCLICKABLE")},D.prototype.onclick=function(){O.prototype.onclick.call(this),"ACTIVE"==this.state&&(at(Ft.BUY,[Wt.team,Ft[this.commandType],Ht[this.commandType],this.buildingSize]),Wt.menuBar.deselect.lockedCoins=Ht[this.commandType])},D.prototype.render=function(t){O.prototype.render.call(this,t),this.renderPrice(t,Ht[this.commandType])},D.prototype.renderPrice=function(t,e){t.save(),t.translate(this.x-this.width/2,this.y-this.height/2);var i=F(e,14);t.translate(this.width-i.width-2,this.height-i.height-2),t.fillStyle="rgba(0,0,0,0.5)",t.fillRect(0,0,i.width,i.height),i.render(t),t.translate(-16,0),t.fillRect(0,0,16,14),t.drawImage(zt.images["asset/pig_coin.png"],0,0,128,128,0,0,14,14),t.restore()},S.prototype=Object.create(D.prototype),S.prototype.update=function(){if("ACTIVE"==Wt.menuBar.upgrade.state){if(2==this.tier[Wt.team]||Ht[this.commandType]>Kt.coins[Wt.team])return void(this.state="UNCLICKABLE");this.state="INACTIVE"}else D.prototype.update.call(this)},S.prototype.onclick=function(){if("ACTIVE"==Wt.menuBar.upgrade.state){if("UNCLICKABLE"==this.state)return;at(Ft[this.tierCommand],[Wt.team]),Wt.menuBar.reset()}else D.prototype.onclick.call(this)},S.prototype.render=function(t){"ACTIVE"==Wt.menuBar.upgrade.state?(O.prototype.render.call(this,t),D.prototype.renderPrice.call(this,t,Ht[this.tierCommand])):D.prototype.render.call(this,t)},M.prototype=Object.create(D.prototype),M.prototype.update=function(){S.prototype.update.call(this)},M.prototype.onclick=function(){S.prototype.onclick.call(this)},M.prototype.render=function(t){S.prototype.render.call(this,t)},B.prototype=Object.create(D.prototype),b.prototype=Object.create(D.prototype),P.prototype=Object.create(O.prototype),P.prototype.update=function(){if("ACTIVE"!=this.state&&"LOCKED"!=this.state){if(Kt.towerTier[Wt.team]+Kt.ranchTier[Wt.team]>=4)return void(this.state="UNCLICKABLE");var t=1e9;1==Kt.towerTier[Wt.team]&&(t=Math.min(t,Ht.UPGRADE_TOWER)),1==Kt.ranchTier[Wt.team]&&(t=Math.min(t,Ht.UPGRADE_PIG_RANCH)),t>Kt.coins[Wt.team]?this.state="UNCLICKABLE":this.state="INACTIVE"}},N.prototype=Object.create(D.prototype),N.prototype.update=function(){return 1==Kt.towerTier[Wt.team]?void(this.state="UNCLICKABLE"):(this.isLocked=!1,void D.prototype.update.call(this))},U.prototype=Object.create(D.prototype),U.prototype.update=function(){return 1==Kt.ranchTier[Wt.team]?void(this.state="UNCLICKABLE"):(this.isLocked=!1,void D.prototype.update.call(this))},G.prototype=Object.create(D.prototype),G.prototype.update=function(){return 1==Kt.ranchTier[Wt.team]?void(this.state="UNCLICKABLE"):(this.isLocked=!1,void D.prototype.update.call(this))},x.prototype=Object.create(D.prototype),x.prototype.update=function(){return 1==Kt.towerTier[Wt.team]?void(this.state="UNCLICKABLE"):(this.isLocked=!1,void D.prototype.update.call(this))},z.prototype=Object.create(O.prototype),
z.prototype.onclick=function(){if(this.toCancel){for(var t=0;t<Wt.menuBar.icons.length;++t)Wt.menuBar.icons[t].state="INACTIVE";this.state="INACTIVE",at(Ft.DESELECT,[Wt.team,this.lockedCoins]),this.lockedCoins=0,Wt.state="NONE",this.toCancel=!1}else"DESTROY"!=Wt.state?Wt.state="DESTROY":Wt.state="NONE"},z.prototype.update=function(){},document.addEventListener("DOMContentLoaded",function(){H()});var xt=io(),zt={assetImageList:["asset/pig_running.png","asset/pig_standby.png","asset/pig_angry.png","asset/pig_eating.png","asset/pig_death.png","asset/boar_running.png","asset/boar_standby.png","asset/boar_attacking.png","asset/boar_eating.png","asset/boar_death.png","asset/tower.png","asset/tower_death.png","asset/castle.png","asset/castle_death.png","asset/rice_field.png","asset/rice_field_death.png","asset/super_rice_field.png","asset/pig_ranch.png","asset/pig_ranch_death.png","asset/pig_hq.png","asset/pig_hq_death.png","asset/block.png","asset/fence.png","asset/super_fence.png","asset/fence_death.png","asset/arrow.png","asset/arrow_death.png","asset/javelin.png","asset/javelin_death.png","asset/throne.png","asset/mouse.png","asset/mouse_shadow.png","asset/destroy.png","asset/tower_icon.png","asset/ranch_icon.png","asset/farm_icon.png","asset/fence_icon.png","asset/upgrade_icon.png","asset/castle_icon.png","asset/pighq_icon.png","asset/wall_icon.png","asset/farm_icon.png","asset/garden_icon.png","asset/deselect_icon.png","asset/pig_coin.png","asset/numbers.png","asset/locked_icon.png","asset/snow.png","asset/pigidow.jpg","asset/snowy-yosemite.jpg","asset/furpig-valley.jpg"],images:{},assetSoundList:[],sounds:{},loadedAssetCount:0},Ft={BUILD_TOWER:0,BUILD_FARM:1,BUILD_PIG_RANCH:2,BUILD_FENCE:3,UPGRADE_TOWER:4,UPGRADE_PIG_RANCH:5,BUY:6,DESELECT:7,BUILD_CASTLE:8,BUILD_GARDEN:9,BUILD_PIG_HQ:10,BUILD_WALL:11,SYNCHRONIZED:12,VICTORY:13,DESTROY:14},Ht={BUILD_TOWER:50,BUILD_FARM:5,BUILD_PIG_RANCH:30,BUILD_FENCE:1,UPGRADE_TOWER:600,UPGRADE_PIG_RANCH:800,BUILD_CASTLE:240,BUILD_GARDEN:35,BUILD_PIG_HQ:220,BUILD_WALL:40},Yt={BACKGROUND_MONEY_RATE:300,MAX_COINS:9999,FPS:1e3/30,SCALER:1.5,SEND_DELAY:100},Vt=[],Kt={},Wt={camera:[0,0],mouse:[0,0],mouseImg:null,team:0,menuBar:null,gameEventHandlerResetFunction:null,state:"NONE",appState:"LOADING_FRAME",online:[],player:{},room:{},roomList:[],playingWithId:null,currentRoom:null,isHost:!1,isGameOngoing:!1,isSinglePlayer:!0,id:0},jt={};[[[Ft.BUILD_PIG_RANCH,[0,2,0]],[Ft.BUILD_PIG_RANCH,[2,2,0]],[Ft.BUILD_FARM,[0,4,0]],[Ft.BUILD_FARM,[0,5,0]],[Ft.BUILD_FARM,[0,6,0]],[Ft.BUILD_FARM,[1,4,0]],[Ft.BUILD_FARM,[1,5,0]],[Ft.BUILD_FARM,[1,6,0]],[Ft.BUILD_FARM,[2,4,0]],[Ft.BUILD_FARM,[2,5,0]],[Ft.BUILD_TOWER,[6,1,0]]],[[Ft.BUILD_PIG_RANCH,[0,6,1]],[Ft.BUILD_PIG_RANCH,[2,6,1]],[Ft.BUILD_FARM,[0,8,1]],[Ft.BUILD_FARM,[0,9,1]],[Ft.BUILD_FARM,[0,10,1]],[Ft.BUILD_FARM,[1,8,1]],[Ft.BUILD_FARM,[1,9,1]],[Ft.BUILD_FARM,[1,10,1]],[Ft.BUILD_FARM,[2,8,1]],[Ft.BUILD_FARM,[2,9,1]],[Ft.BUILD_TOWER,[6,10,1]],[Ft.BUILD_TOWER,[4,10,1]],[Ft.BUILD_TOWER,[9,10,1]]]]}();